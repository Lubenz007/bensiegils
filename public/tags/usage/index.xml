<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>BensiEgils â€“ Usage</title><link>https://lubenz007.github.io/bensiegils/tags/usage/</link><description>Recent content in Usage on BensiEgils</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 13 May 2023 14:00:00 +0000</lastBuildDate><atom:link href="https://lubenz007.github.io/bensiegils/tags/usage/index.xml" rel="self" type="application/rss+xml"/><item><title>Monitor Azure Usage for a subscription</title><link>https://lubenz007.github.io/bensiegils/posts/monitor-azure-usage-for-a-subscription/</link><pubDate>Sat, 13 May 2023 14:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/monitor-azure-usage-for-a-subscription/</guid><description>
&lt;p>Why do we need to monitor Azure usage? Well, if you have a subscription with a spending limit, you need to keep track of your usage. If you go over the spending limit, your resources will be disabled. And you will need to pay for the overage.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Info:&lt;/strong> My concern is that some one gets a hold of my subscription, and start to use it. And I will get a big bill at the end of the month.&lt;/p>
&lt;/blockquote>
&lt;p>Using Get-AzConsumptionUsageDetail to get the usage for a subscription. Works not for Azure Plan subscriptions.
Bcause of this error: ((400) Subscription scope usage is not supported for current api version. Please use api version after 2019-10-01)&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Tip:&lt;/strong> But we can use the Microsoft.Consumption/usageDetails API to get the usage for a subscription.&lt;/p>
&lt;/blockquote>
&lt;p>First we need to create a Service Principal, and we need to give service principal billing role on the subscription.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c">#This script will get the usage for a subscription&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$startDate&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Date&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">AddDays&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">-2&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">ToString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;yyyy-MM-dd&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$endDate&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Date&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">AddDays&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">-1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">ToString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;yyyy-MM-dd&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#set the variables&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ClientID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ClientSecret&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$tenant_Id&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$subscriptionId&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Set the URI for the request.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$uri1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>&lt;span class="nv">$subscriptionId&lt;/span>&lt;span class="s2">/providers/Microsoft.Consumption/usageDetails?api-version=2023-03-01&amp;amp;startDate=&lt;/span>&lt;span class="nv">${startDate}&lt;/span>&lt;span class="s2">&amp;amp;endDate=&lt;/span>&lt;span class="nv">${startDate}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$uri2&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>&lt;span class="nv">$subscriptionId&lt;/span>&lt;span class="s2">/providers/Microsoft.Consumption/usageDetails?api-version=2023-03-01&amp;amp;startDate=&lt;/span>&lt;span class="nv">${endDate}&lt;/span>&lt;span class="s2">&amp;amp;endDate=&lt;/span>&lt;span class="nv">${endDate}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create the body of the request.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Grant_Type&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Resource&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;https://management.azure.com/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client_id&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$clientId&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client_secret&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$clientSecret&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ConnectGraph&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Invoke-RestMethod&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="s2">&amp;#34;https://login.microsoft.com/&lt;/span>&lt;span class="nv">$tenant_Id&lt;/span>&lt;span class="s2">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> &lt;span class="n">-Method&lt;/span> &lt;span class="n">POST&lt;/span> &lt;span class="n">-Body&lt;/span> &lt;span class="nv">$Body&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Headers&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;Authorization&amp;#39;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Bearer &lt;/span>&lt;span class="p">$(&lt;/span>&lt;span class="nv">$ConnectGraph&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">access_token&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="no">Net.ServicePointManager&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">SecurityProtocol&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">Net.SecurityProtocolType&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Tls12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#function to get graph data with pagination&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">function&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Get-GraphData&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">param&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>&lt;span class="nb">parameter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="na">Mandatory&lt;/span>&lt;span class="p">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>&lt;span class="no">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$AccessToken&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>&lt;span class="nb">parameter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="na">Mandatory&lt;/span>&lt;span class="p">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>&lt;span class="no">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$Uri&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$Headers&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;Authorization&amp;#39;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Bearer &lt;/span>&lt;span class="nv">$AccessToken&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">do&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$Results&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Invoke-RestMethod&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="nv">$Uri&lt;/span> &lt;span class="n">-Headers&lt;/span> &lt;span class="nv">$Headers&lt;/span> &lt;span class="n">-ErrorAction&lt;/span> &lt;span class="n">Stop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$QueryResults&lt;/span> &lt;span class="p">+=&lt;/span> &lt;span class="nv">$Results&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$Uri&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$Results&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="s1">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$Uri&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$QueryResults&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#$useage = Invoke-WebRequest -Method GET -Uri $Uri -ContentType &amp;#34;application/json&amp;#34; -Headers $headers | ConvertFrom-Json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$uritwodaysago&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-GraphData&lt;/span> &lt;span class="n">-AccessToken&lt;/span> &lt;span class="nv">$ConnectGraph&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">access_token&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="nv">$uri1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$uriyesterday&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-GraphData&lt;/span> &lt;span class="n">-AccessToken&lt;/span> &lt;span class="nv">$ConnectGraph&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">access_token&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="nv">$uri2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Resultstwodaysago&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$uritwodaysago&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Select-Object&lt;/span> &lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">properties&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Measure-Object&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="n">costInBillingCurrency&lt;/span> &lt;span class="n">-Sum&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Select-Object&lt;/span> &lt;span class="n">Sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Resultyesterday&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$uriyesterday&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Select-Object&lt;/span> &lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">properties&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Measure-Object&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="n">costInBillingCurrency&lt;/span> &lt;span class="n">-Sum&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Select-Object&lt;/span> &lt;span class="n">Sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Resultstwodaysago&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">math&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Floor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$Resultstwodaysago&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Resultyesterday&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">math&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ceiling&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$Resultyesterday&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$percentof&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">math&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Floor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$Resultstwodaysago&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="mf">1.4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$Resultstwodaysago&lt;/span> &lt;span class="o">-le&lt;/span> &lt;span class="nv">$percentof&lt;/span> &lt;span class="o">-and&lt;/span> &lt;span class="nv">$Resultyesterday&lt;/span> &lt;span class="o">-lt&lt;/span> &lt;span class="mf">100&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="s2">&amp;#34;OK: Yesterday&amp;#39;s Azure spending (&lt;/span>&lt;span class="nv">$Resultyesterday&lt;/span>&lt;span class="s2"> Euro) is not 40% more than 2 days ago (&lt;/span>&lt;span class="nv">$Resultstwodaysago&lt;/span>&lt;span class="s2"> Euro) and not more than 100 Euro | yesterday=&lt;/span>&lt;span class="nv">$Resultyesterday&lt;/span>&lt;span class="s2">, spending2daysago=&lt;/span>&lt;span class="nv">$Resultstwodaysago&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="s2">&amp;#34;Alarm!! Tom Much Azure Spending&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$webhookUri&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;webhook from teams&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;@context&amp;#34;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;http://schema.org/extensions&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;@typecod&amp;#34;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;MessageCard&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;themeColor&amp;#34;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;d70000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;title&amp;#34;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Alarm!! To Much Azure Spending&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Some thing is wrong in Azure. Yesterday&amp;#39;s Azure spending (&lt;/span>&lt;span class="nv">$Resultyesterday&lt;/span>&lt;span class="s2"> Euro) is 40% more than 2 days ago (&lt;/span>&lt;span class="nv">$Resultstwodaysago&lt;/span>&lt;span class="s2"> Euro) or more than 100 Euro&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Invoke-RestMethod&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="nv">$webhookUri&lt;/span> &lt;span class="n">-Method&lt;/span> &lt;span class="n">Post&lt;/span> &lt;span class="n">-Body&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">ConvertTo-Json&lt;/span> &lt;span class="n">-InputObject&lt;/span> &lt;span class="nv">$body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>Monitor Azure usage with github actions</title><link>https://lubenz007.github.io/bensiegils/posts/monitor-azure-usage-with-github-actions/</link><pubDate>Sat, 13 May 2023 14:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/monitor-azure-usage-with-github-actions/</guid><description>
&lt;blockquote>
&lt;p>This will not work for Azure Plan subscriptions.
((400) Subscription scope usage is not supported for current api version. Please use api version after 2019-10-01)
{: .prompt-info }&lt;/p>
&lt;/blockquote>
&lt;h3>Need to keep track of your Azure usage? here is a way to use github actions to keep track of your usage. And send you a Teams message if you are over a certain amount.&lt;span class="hx:absolute hx:-mt-20" id="need-to-keep-track-of-your-azure-usage-here-is-a-way-to-use-github-actions-to-keep-track-of-your-usage-and-send-you-a-teams-message-if-you-are-over-a-certain-amount">&lt;/span>
&lt;a href="#need-to-keep-track-of-your-azure-usage-here-is-a-way-to-use-github-actions-to-keep-track-of-your-usage-and-send-you-a-teams-message-if-you-are-over-a-certain-amount" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>We will need to enable webhook in Teams and add the webhook to the script, and create a Service Principal with access to the subscription you want to monitor.
{: .prompt-tip }&lt;/p>
&lt;/blockquote>
&lt;p>Create Service Principal and give it access to the subscription you want to monitor.
Copy the output from the command below and add it to the github repository as a secret, AZURE_CREDENTIALS.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">az&lt;/span> &lt;span class="n">ad&lt;/span> &lt;span class="nb">sp create-for&lt;/span>&lt;span class="n">-rbac&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-name&lt;/span> &lt;span class="s2">&amp;#34;AzureUsage&amp;#34;&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-role&lt;/span> &lt;span class="n">contributor&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-scopes&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">subscriptions&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">0692777c&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-sdk-auth&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/azurelogin.png" alt="Desktop View" loading="lazy" />{: .normal-image}&lt;/p>
&lt;blockquote>
&lt;p>We will need to add secret to the repository, AZURE_CREDENTIALS, and add the output from the command above.
{: .prompt-tip }
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/gitsecret.png" alt="Desktop View" loading="lazy" />{: .normal-image}&lt;/p>
&lt;/blockquote>
&lt;p>Github actions, it runs every day at midnight.&lt;/p>
&lt;ul>
&lt;li>cron: &amp;lsquo;0 0 * * *&amp;rsquo; # every day at midnight&lt;/li>
&lt;/ul>
&lt;p>This is the workflow file&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># File: .github/workflows/workflow.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">schedule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">cron&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0 0 * * *&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># every day at midnight&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AzureUsage&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">jobs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">build-and-deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">runs-on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu-latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">azure/login@v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">creds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ secrets.AZURE_CREDENTIALS }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enable-AzPSSession&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Run Azure PowerShell script&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">azure/powershell@v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">inlinescript&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $startDate = (Get-Date).AddDays(-2).ToString(&amp;#34;yyyy-MM-dd&amp;#34;)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $endDate = (Get-Date).AddDays(-1).ToString(&amp;#34;yyyy-MM-dd&amp;#34;)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $twodaysago = Get-AzConsumptionUsageDetail -StartDate $startDate -EndDate $startDate | Measure-Object -Property PretaxCost -Sum | Select-Object Sum
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $yesterday = Get-AzConsumptionUsageDetail -StartDate $enddate -EndDate $enddate | Measure-Object -Property PretaxCost -Sum | Select-Object Sum
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $twodaysago = [math]::Floor($twodaysago.sum)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $yesterday = [math]::ceiling($yesterday.sum)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $percentof = [math]::Floor($twodaysago * 1.4)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> if ($twodaysago -le $percentof -and $yesterday -lt 100) {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> Write-Host &amp;#34;OK: Yesterday&amp;#39;s Azure spending ($yesterday Euro) is not 40% more than 2 days ago ($twodaysago Euro) and not more than 100 Euro | yesterday=$yesterday, spending2daysago=$twodaysago&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> else
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> Write-Host &amp;#34;Alarm!! Tom Much Azure Spending&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $webhookUri = &amp;#34;webhook from teams&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> $body = @{
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;@context&amp;#34; = &amp;#34;http://schema.org/extensions&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;@typecod&amp;#34; = &amp;#34;MessageCard&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;themeColor&amp;#34; = &amp;#34;d70000&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;title&amp;#34; = &amp;#34;Alarm!! To Much Azure Spending&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> &amp;#34;text&amp;#34; = &amp;#34;Some thing is wrong in Azure. Yesterday&amp;#39;s Azure spending ($yesterday Euro) is 40% more than 2 days ago ($twodaysago Euro) or more than 100 Euro&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> Invoke-RestMethod -Uri $webhookUri -Method Post -Body (ConvertTo-Json -InputObject $body)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> }&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">azPSVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;latest&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/AzureCred.png" alt="Desktop View" loading="lazy" />
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/spending.png" alt="Desktop View" loading="lazy" />&lt;/p></description></item><item><title>Azure Cost CLI</title><link>https://lubenz007.github.io/bensiegils/posts/azure-cost-cli/</link><pubDate>Wed, 03 May 2023 20:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/azure-cost-cli/</guid><description>
&lt;p>Azure-Cost-CLI is a powerful tool to get cost information from Azure directly from the command line. &lt;a href="https://github.com/mivano/azure-cost-cli"target="_blank" rel="noopener">GitHub Repository&lt;/a>&lt;/p>
&lt;h2>Benefits of This Tool&lt;span class="hx:absolute hx:-mt-20" id="benefits-of-this-tool">&lt;/span>
&lt;a href="#benefits-of-this-tool" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>Get cost information without logging into the Azure portal&lt;/li>
&lt;li>Send Teams messages with cost information&lt;/li>
&lt;li>Send emails with cost reports&lt;/li>
&lt;li>Perfect for automation and scheduled reporting&lt;/li>
&lt;/ul>
&lt;h1>Azure Cost Overview&lt;/h1>&lt;blockquote class="white">
Accumulated cost for subscription id `0692777c-ed93-4a6a-85c7-144c24xxxx` from **1.5.2023** to **9.5.2023**
&lt;/blockquote>
&lt;h2>Totals&lt;span class="hx:absolute hx:-mt-20" id="totals">&lt;/span>
&lt;a href="#totals" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Period&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Today&lt;/td>
&lt;td style="text-align: right">0,90 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Yesterday&lt;/td>
&lt;td style="text-align: right">2,21 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Last 7 days&lt;/td>
&lt;td style="text-align: right">17,26 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Last 30 days&lt;/td>
&lt;td style="text-align: right">19,40 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
gantt
title Accumulated cost
dateFormat X
axisFormat %s
section 01 maÃ­
EUR 2,14 :0, 214
section 02 maÃ­
EUR 4,24 :0, 424
section 03 maÃ­
EUR 6,37 :0, 637
section 04 maÃ­
EUR 8,51 :0, 851
section 05 maÃ­
EUR 11,00 :0, 1100
section 06 maÃ­
EUR 13,61 :0, 1361
section 07 maÃ­
EUR 16,29 :0, 1629
section 08 maÃ­
EUR 18,50 :0, 1850
section 09 maÃ­
EUR 19,40 :0, 1940
section 10 maÃ­
EUR 21,36 : done, 0, 2136
section 11 maÃ­
EUR 23,33 : done, 0, 2333
section 12 maÃ­
EUR 25,52 : done, 0, 2552
section 13 maÃ­
EUR 27,71 : done, 0, 2771
section 14 maÃ­
EUR 30,04 : done, 0, 3004
section 15 maÃ­
EUR 32,19 : done, 0, 3219
section 16 maÃ­
EUR 34,08 : done, 0, 3408
section 17 maÃ­
EUR 35,99 : done, 0, 3599
section 18 maÃ­
EUR 37,91 : done, 0, 3791
section 19 maÃ­
EUR 40,04 : done, 0, 4004
section 20 maÃ­
EUR 42,18 : done, 0, 4218
section 21 maÃ­
EUR 44,46 : done, 0, 4446
section 22 maÃ­
EUR 46,54 : done, 0, 4654
section 23 maÃ­
EUR 48,39 : done, 0, 4839
section 24 maÃ­
EUR 50,24 : done, 0, 5024
section 25 maÃ­
EUR 52,10 : done, 0, 5210
section 26 maÃ­
EUR 54,18 : done, 0, 5418
section 27 maÃ­
EUR 56,26 : done, 0, 5626
section 28 maÃ­
EUR 58,48 : done, 0, 5848
section 29 maÃ­
EUR 60,51 : done, 0, 6051
section 30 maÃ­
EUR 62,30 : done, 0, 6230
section 31 maÃ­
EUR 64,10 : done, 0, 6410
&lt;/pre>&lt;h2>By Service Name&lt;span class="hx:absolute hx:-mt-20" id="by-service-name">&lt;/span>
&lt;a href="#by-service-name" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Service&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Backup&lt;/td>
&lt;td style="text-align: right">21,92 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Security Center&lt;/td>
&lt;td style="text-align: right">9,88 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Azure App Service&lt;/td>
&lt;td style="text-align: right">2,52 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Virtual Network&lt;/td>
&lt;td style="text-align: right">1,40 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Log Analytics&lt;/td>
&lt;td style="text-align: right">1,21 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Sentinel&lt;/td>
&lt;td style="text-align: right">1,00 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Azure DNS&lt;/td>
&lt;td style="text-align: right">0,52 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Storage&lt;/td>
&lt;td style="text-align: right">0,31 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Advanced Threat Protection&lt;/td>
&lt;td style="text-align: right">0,04 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Others&lt;/td>
&lt;td style="text-align: right">0,00 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
pie
title Cost by service
&amp;#34;Backup&amp;#34; : 21.92
&amp;#34;Security Center&amp;#34; : 9.88
&amp;#34;Azure App Service&amp;#34; : 2.52
&amp;#34;Virtual Network&amp;#34; : 1.40
&amp;#34;Log Analytics&amp;#34; : 1.21
&amp;#34;Sentinel&amp;#34; : 1.00
&amp;#34;Azure DNS&amp;#34; : 0.52
&amp;#34;Storage&amp;#34; : 0.31
&amp;#34;Advanced Threat Protection&amp;#34; : 0.04
&amp;#34;Others&amp;#34; : 0.00
&lt;/pre>&lt;h2>By Location&lt;span class="hx:absolute hx:-mt-20" id="by-location">&lt;/span>
&lt;a href="#by-location" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Location&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>EU West&lt;/td>
&lt;td style="text-align: right">8,23 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Unassigned&lt;/td>
&lt;td style="text-align: right">4,96 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>US West&lt;/td>
&lt;td style="text-align: right">4,07 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>EU North&lt;/td>
&lt;td style="text-align: right">1,88 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Unknown&lt;/td>
&lt;td style="text-align: right">0,26 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
pie
title Cost by location
&amp;#34;EU West&amp;#34; : 8.23
&amp;#34;Unassigned&amp;#34; : 4.96
&amp;#34;US West&amp;#34; : 4.07
&amp;#34;EU North&amp;#34; : 1.88
&amp;#34;Unknown&amp;#34; : 0.26
&lt;/pre>&lt;h2>By Resource Group&lt;span class="hx:absolute hx:-mt-20" id="by-resource-group">&lt;/span>
&lt;a href="#by-resource-group" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Resource Group&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>bensa&lt;/td>
&lt;td style="text-align: right">6,80 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>microsoft.security&lt;/td>
&lt;td style="text-align: right">4,96 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>backuptest&lt;/td>
&lt;td style="text-align: right">4,07 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>alitis&lt;/td>
&lt;td style="text-align: right">2,22 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>test2&lt;/td>
&lt;td style="text-align: right">1,35 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
pie
title Cost by resource group
&amp;#34;bensa&amp;#34; : 6.80
&amp;#34;microsoft.security&amp;#34; : 4.96
&amp;#34;backuptest&amp;#34; : 4.07
&amp;#34;alitis&amp;#34; : 2.22
&amp;#34;test2&amp;#34; : 1.35
&lt;/pre>&lt;p>&lt;sup>Generated at 2023-05-09 23:33:20&lt;/sup>&lt;/p></description></item></channel></rss>