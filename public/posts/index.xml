<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>BensiEgils â€“ Blog Posts</title><link>https://lubenz007.github.io/bensiegils/posts/</link><description>Recent content in Blog Posts on BensiEgils</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 18 Aug 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://lubenz007.github.io/bensiegils/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Migrating from VMware to Azure using Azure Files</title><link>https://lubenz007.github.io/bensiegils/posts/2025-08-19-move-vmware-azure/</link><pubDate>Mon, 18 Aug 2025 00:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2025-08-19-move-vmware-azure/</guid><description>
&lt;p>When using a tool such as Disk2VHD, you need a storage locationâ€”and sometimes plenty of itâ€”to export the virtual machine (VM).
But what if no local storage is available, and no USB can be connected, such as with a VMware hosting provider?&lt;/p>
&lt;p>In that case, you can export the VHD directly to an Azure File Share and then copy it to Azure Blob Storage.
Note: Dynamically expanding disks are not supported in this processâ€”you must use a fixed-size disk.&lt;/p>
&lt;p>The next step is to provision a Windows Server in Azure, install Hyper-V, and use Hyper-V Manager to convert the disk to a fixed-size VHD.&lt;/p>
&lt;p>After conversion, you can upload the VHD to Azure, create an image from it, and then deploy a VM.
In many cases, Azure will display an error during deployment stating that the VM cannot be customized. You can safely ignore this error.&lt;/p>
&lt;p>Tools You Will Need&lt;/p>
&lt;ul>
&lt;li>Disk2VHD â€“ for exporting the VMware VM to a VHD file.
&lt;ul>
&lt;li>ðŸ”— Download Disk2VHD&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Azure Storage Explorer â€“ for managing Azure File Shares and Blob Storage.
&lt;ul>
&lt;li>ðŸ”— Download Azure Storage Explorer&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Hyper-V Manager â€“ for converting VHDs from dynamic to fixed-size.
&lt;ul>
&lt;li>Installed on VM in Azure&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Step 1:&lt;/strong> Mount Azure File Share&lt;/p>
&lt;p>On the source VMware server and later on the Hyper-V server in Azure, mount the Azure File Share:
Mount as Administrator because disk2vhd runs as Administrator.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/blob.png" alt="Mount Azure File Share" loading="lazy" />&lt;/p>
&lt;p>&lt;strong>Step 2:&lt;/strong> Export VMware VM with Disk2VHD&lt;/p>
&lt;p>Run Disk2VHD on the source server.&lt;/p>
&lt;p>Select the volumes you want to export.&lt;/p>
&lt;p>Choose the Azure File Share as the destination path (after mounting it as a network drive).&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/disk2vhd1.png" alt="Disk2VHD Export" loading="lazy" />
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/uncheck.png" alt="Disk2VHD Uncheck" loading="lazy" />&lt;/p>
&lt;p>&lt;strong>Step 3:&lt;/strong> Convert VHD from Dynamic to Fixed&lt;/p>
&lt;p>Open Hyper-V Manager on the Azure VM.&lt;/p>
&lt;p>Go to Edit Diskâ€¦&lt;/p>
&lt;p>Browse to the VHD file from the Azure File Share.&lt;/p>
&lt;p>Select Convert â†’ Fixed size.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/fxiedsize.png" alt="Fixed Size VHD" loading="lazy" />&lt;/p>
&lt;p>Step 4: Copy VHD to Azure Blob Storage&lt;/p>
&lt;p>Use Azure Storage Explorer ( Use copy and paste in the menu :) )&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/storageexplorer.png" alt="Azure Storage Explorer" loading="lazy" />&lt;/p>
&lt;p>Step 5: Create Azure Managed Image &amp;amp; VM&lt;/p>
&lt;p>In the Azure Portal, go to Images â†’ + Create.&lt;/p>
&lt;p>Select your uploaded VHD as the source.&lt;/p>
&lt;p>Create an image.&lt;/p>
&lt;p>Deploy a VM from that image.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/azimagecreate.png" alt="Azure Image Create" loading="lazy" />&lt;/p>
&lt;p>Now you can create vm from the image.&lt;/p></description></item><item><title>GSPRO Control box</title><link>https://lubenz007.github.io/bensiegils/posts/2024-06-23-gspro-controlbox/</link><pubDate>Sun, 23 Jun 2024 00:27:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2024-06-23-gspro-controlbox/</guid><description>
&lt;p>ESP32 code to create a GSPRO Control box with Bluetooth connectivity and 12 programmable keys for enhanced golf simulator control.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/gspro/bord1.png" alt="Desktop View" loading="lazy" />
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/gspro/box.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;h2>Features&lt;span class="hx:absolute hx:-mt-20" id="features">&lt;/span>
&lt;a href="#features" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>12 programmable keys with custom functions&lt;/li>
&lt;li>Bluetooth Low Energy connectivity&lt;/li>
&lt;li>Camera controls, scorecard display, pin viewing&lt;/li>
&lt;li>Arrow key navigation and visual settings&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// Benedikt Gabriel Egilsson - bensiegils.com&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 1= 5 - Camera to ball&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 2= KEY_M_CTRL - Muligan &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 3= T - Scorecard display&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 4= P - See the pin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 5= O - Flyover of the hole&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 6= . - shadow quality&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 7= B - Hide - Make objects in your line of sight invisible &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 8= Z - Hide or show the 3D gras&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 9= KEY_UP_ARROW&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 10= KEY_DOWN_ARROW&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 11= KEY_LEFT_ARROW&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">// 12= KEY_RIGHT_ARROW&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define USE_NIMBLE&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include &amp;lt;BleKeyboard.h&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">BleKeyboard bleKeyboard(&amp;#34;GSPRO BOX&amp;#34;);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define NUM_KEYS 12&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">struct Key {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">int pin;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">uint8_t code;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bool state;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bool isCtrl; // New field to indicate if Ctrl needs to be held&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;span style="color:#ae81ff">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">Key keys[NUM_KEYS] = {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">16&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;5&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">17&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;m&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">true&lt;/span>}, &lt;span style="color:#ae81ff">// &amp;#39;m&amp;#39; with Ctrl modifier&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">18&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;t&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">19&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;p&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">21&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;o&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">22&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;.&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">32&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;b&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">33&lt;/span>, &lt;span style="color:#e6db74">&amp;#39;z&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>, &lt;span style="color:#66d9ef">false&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">27&lt;/span>, &lt;span style="color:#ae81ff">KEY_UP_ARROW, false, false},&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">14&lt;/span>, &lt;span style="color:#ae81ff">KEY_DOWN_ARROW, false, false},&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">12&lt;/span>, &lt;span style="color:#ae81ff">KEY_LEFT_ARROW, false, false},&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#ae81ff">13&lt;/span>, &lt;span style="color:#ae81ff">KEY_RIGHT_ARROW, false, false}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;span style="color:#ae81ff">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">bool connectNotificationSent = false;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">void setup() {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">Serial.begin(115200);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">Serial.println(&amp;#34;Code running...&amp;#34;);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">// Set pin modes&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">for (int i = 0; i &amp;lt; NUM_KEYS; i++) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">pinMode(keys[i].pin, INPUT_PULLUP);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">// Initialize BLE keyboard&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bleKeyboard.begin();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">void loop() {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">if (bleKeyboard.isConnected()) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">if (!connectNotificationSent) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">Serial.println(&amp;#34;BLE connected...&amp;#34;);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">connectNotificationSent = true;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">for (int i = 0; i &amp;lt; NUM_KEYS; i++) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">handleButton(i);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#ae81ff">else {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">if (connectNotificationSent) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">Serial.println(&amp;#34;BLE disconnected...&amp;#34;);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">connectNotificationSent = false;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">delay(10); // Small delay to stabilize readings&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">void handleButton(int keyIndex) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bool currentState = !digitalRead(keys[keyIndex].pin); // Read the button state (active low)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">if (currentState != keys[keyIndex].state) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">keys[keyIndex].state = currentState;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">if (currentState) {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">if (keys[keyIndex].isCtrl) { // Check if Ctrl modifier is needed&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bleKeyboard.press(KEY_LEFT_CTRL);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bleKeyboard.press(keys[keyIndex].code);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">Serial.print(&amp;#34;Key pressed: &amp;#34;);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#ae81ff">else {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bleKeyboard.release(keys[keyIndex].code);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">if (keys[keyIndex].isCtrl) { // Check if Ctrl modifier is needed&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">bleKeyboard.release(KEY_LEFT_CTRL);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">Serial.print(&amp;#34;Key released: &amp;#34;);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">Serial.println(keys[keyIndex].code);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>Arc - Diskspace Monitoring - Teams)</title><link>https://lubenz007.github.io/bensiegils/posts/2023-10-15-outofdiskspace-teams/</link><pubDate>Sun, 15 Oct 2023 02:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-10-15-outofdiskspace-teams/</guid><description>
&lt;p>Monitor disk space usage on Azure Arc-enabled servers and receive instant Microsoft Teams notifications when space is running low.&lt;/p>
&lt;h2>Azure Arc Disk Space Monitoring&lt;span class="hx:absolute hx:-mt-20" id="azure-arc-disk-space-monitoring">&lt;/span>
&lt;a href="#azure-arc-disk-space-monitoring" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Upon successfully installing Azure Arc on your Server and activating Insights, you open the door to a powerful monitoring capability. One essential aspect is overseeing disk space usage on your server, ensuring optimal performance and preventing potential issues. This example provides a step-by-step guide on how to set up disk space monitoring and receive instant notifications via Microsoft Teams when space is running low.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Furthermore, this versatile approach can be extended to send email alerts, providing an additional layer of flexibility in how you manage critical resource thresholds. This comprehensive monitoring strategy empowers you with the tools to proactively maintain your server&amp;rsquo;s health and responsiveness, bolstering the reliability of your operations.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The query below is a simple example of how to monitor disk space usage on your server. It returns the percentage of free space on the C: drive, which is then used to trigger an alert when the threshold is exceeded. The query can be customized to monitor other drives on your server, and the threshold can be adjusted to suit your needs.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>InsightsMetrics
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| where Name == &lt;span style="color:#e6db74">&amp;#34;FreeSpaceMB&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| summarize arg_max(TimeGenerated, *) by Tags, Computer
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| extend Drive = tostring(parse_json(Tags)[&lt;span style="color:#e6db74">&amp;#34;vm.azm.ms/mountId&amp;#34;&lt;/span>])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| extend Size = toreal(parse_json(Tags)[&lt;span style="color:#e6db74">&amp;#34;vm.azm.ms/diskSizeMB&amp;#34;&lt;/span>])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| project TimeGenerated, Computer, Drive, bin(SizeGB = Size / &lt;span style="color:#ae81ff">1024&lt;/span>, &lt;span style="color:#ae81ff">0.1&lt;/span>), bin(FreeGB = Val / &lt;span style="color:#ae81ff">1024&lt;/span>, &lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| join kind=inner (InsightsMetrics
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> | where Name == &lt;span style="color:#e6db74">&amp;#34;FreeSpacePercentage&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> | summarize arg_max(TimeGenerated, *) by Tags, Computer
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> | extend Drive = tostring(parse_json(Tags)[&lt;span style="color:#e6db74">&amp;#34;vm.azm.ms/mountId&amp;#34;&lt;/span>])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> | project TimeGenerated, Computer, Drive, bin(FreePercent = Val, &lt;span style="color:#ae81ff">1.1&lt;/span>))on Computer, Drive
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| project TimeGenerated, Computer, Drive, SizeGB, FreeGB, FreePercent
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| where FreePercent &amp;lt;= &lt;span style="color:#ae81ff">90.0&lt;/span> //
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>//| where FreeGB &amp;lt;= &lt;span style="color:#ae81ff">10.0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>| order by Computer asc&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>
&lt;p>We need to enable webhooks in Microsoft Teams and copy the webhook URL. Finally, we need to create Azure automation runbook and configure it to send notifications to the channel.
We also need to enable the Azure Automation account to access the Log Analytics workspace. To do this, we need to give automation account read access to the Log Analytics workspace and resource group where the arc servers are located.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>the runbook code is the following:&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># So we are going to use the same query as in Azure Monitor to get the results and send it to Teams&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Connect to Azure for Log Analytics&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Connect-AzAccount -Identity
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$context = Set-AzContext -Subscription &lt;span style="color:#e6db74">&amp;#34;Your Subscription Name&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$workspaceName = &lt;span style="color:#e6db74">&amp;#34;arc-servers&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$workspaceRG = &lt;span style="color:#e6db74">&amp;#34;arc-servers&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$WorkspaceID = (Get-AzOperationalInsightsWorkspace -Name $workspaceName -ResourceGroupName $workspaceRG).CustomerID
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$query = &lt;span style="color:#e6db74">&amp;#34;InsightsMetrics
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| where Name == &lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">FreeSpaceMB&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| summarize arg_max(TimeGenerated, *) by Tags, Computer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| extend Drive = tostring(parse_json(Tags)[&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">vm.azm.ms/mountId&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">])
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| extend Size = toreal(parse_json(Tags)[&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">vm.azm.ms/diskSizeMB&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">])
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| project TimeGenerated, Computer, Drive, bin(SizeGB = Size / 1024, 0.1), bin(FreeGB = Val / 1024, 1)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| join kind=inner (InsightsMetrics
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> | where Name == &lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">FreeSpacePercentage&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> | summarize arg_max(TimeGenerated, *) by Tags, Computer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> | extend Drive = tostring(parse_json(Tags)[&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">vm.azm.ms/mountId&lt;/span>&lt;span style="color:#ae81ff">`&amp;#34;&lt;/span>&lt;span style="color:#e6db74">])
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> | project TimeGenerated, Computer, Drive, bin(FreePercent = Val, 1.1))on Computer, Drive
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| project TimeGenerated, Computer, Drive, SizeGB, FreeGB, FreePercent
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| where FreePercent &amp;lt;= 90.0 //
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">//| where FreeGB &amp;lt;= 10.0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">| order by Computer asc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$kqlQuery = Invoke-AzOperationalInsightsQuery -WorkspaceId $WorkspaceID -Query $query
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$webhookUri = &lt;span style="color:#e6db74">&amp;#34;your webhook url&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Define the message as a PowerShell object&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$message = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> context = &lt;span style="color:#e6db74">&amp;#34;http://schema.org/extensions&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> type = &lt;span style="color:#e6db74">&amp;#34;MessageCard&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> themeColor = &lt;span style="color:#e6db74">&amp;#34;d70000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> title = &lt;span style="color:#e6db74">&amp;#34;Machine with low disk space&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> text = &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$($kqlQuery.results | Format-List | Out-String)&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Convert the message to JSON&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$jsonMessage = $message | ConvertTo-Json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Send the message using Invoke-RestMethod&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Invoke-RestMethod -Method Post -ContentType &lt;span style="color:#e6db74">&amp;#39;application/json&amp;#39;&lt;/span> -Body $jsonMessage -Uri $webhookUri&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>
&lt;p>Select create alert rule
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/AzureMonitor.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Create a new alert rule
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Create_an_alert_rule.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Create action group
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Action_Group.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Select the runbook with teams notification that we create before&lt;/p>
&lt;/li>
&lt;li>
&lt;p>the result in teams
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/diskalert_teams.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Azure Arc - (Azure Cli - ssh - rdp)</title><link>https://lubenz007.github.io/bensiegils/posts/2023-10-08-azurearc-ssh/</link><pubDate>Sun, 08 Oct 2023 02:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-10-08-azurearc-ssh/</guid><description>
&lt;p>If you have deployed Azure Arc, you have the option to utilize Windows Admin Center for Windows Machines. Additionally, you can enable the OpenSSH Extension on Windows Server, granting the capability to establish SSH tunnels to the localhost or other machines that support RDP/SSH connections.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/SSH-Tunnel.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>To begin the process, please follow these steps:&lt;/p>
&lt;p>Ensure that you have the Azure CLI installed on your local computer. If it is not already installed, open PowerShell and execute the command: winget install -e &amp;ndash;id Microsoft.AzureCLI.&lt;/p>
&lt;p>If you are using a different operating system, refer to the official guide on how to install the Azure CLI provided by Microsoft Learn:
&lt;a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli"target="_blank" rel="noopener">How to install the Azure CLI | Microsoft Learn.&lt;/a>&lt;/p>
&lt;p>Next, enable the OpenSSH extension on the VM where Azure Arc is deployed.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Enable-SSH.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Settings-Extensions.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;ul>
&lt;li>Logon to Azure With Azure CLi&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>PS C:\&amp;gt; az login&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>&lt;strong>Tip:&lt;/strong> Please use Multi-Factor Authentication for added security.&lt;/p>
&lt;/blockquote>
&lt;p>The we go to the Connect settings and select password authentication on the VM
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Connect_string.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>Copy the connect string and paste to Powershell and add &amp;ldquo;-L 3333:192.168.x.x:3389&amp;rdquo; the ip of the host you want to connect to.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>az ssh arc --subscription &lt;span style="color:#e6db74">&amp;#34;asdfasdfadf-adfadsfadsf-sdfc&amp;#34;&lt;/span> --resource-group &lt;span style="color:#e6db74">&amp;#34;Arc-Servers&amp;#34;&lt;/span> --name &lt;span style="color:#e6db74">&amp;#34;HYPER-01&amp;#34;&lt;/span> --local-user &lt;span style="color:#e6db74">&amp;#34;administrator&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;-L 3333:192.168.81.25:3389&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/RDP_Session1.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/RDP_Session2.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>And you are connect over SSH tunnel with RDP.&lt;/p></description></item><item><title>hyper-v-tool</title><link>https://lubenz007.github.io/bensiegils/posts/2023-09-30-hyper-v-tool/</link><pubDate>Sat, 30 Sep 2023 14:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-09-30-hyper-v-tool/</guid><description>
&lt;p>My tool to create VMs in my lab environment with streamlined automation.&lt;/p>
&lt;p>&lt;strong>GitHub Repository:&lt;/strong> &lt;a href="https://github.com/Lubenz007/hyper-v-tool"target="_blank" rel="noopener">https://github.com/Lubenz007/hyper-v-tool&lt;/a>&lt;/p>
&lt;p>Utilizing a standalone Hyper-V server and generating VMs from a golden image might be considered an older approach, but it&amp;rsquo;s one I personally prefer. Over the years, I&amp;rsquo;ve diligently maintained a tool for crafting VMs on my Hyper-V host within the lab environment. I employ SSH to connect to the Hyper-V host and initiate the VM creation process. This tool provides a streamlined menu system that automatically configures the VM, allowing me to promptly begin using it.&lt;/p>
&lt;ul>
&lt;li>All config is done in the vm_menu.ps1&lt;/li>
&lt;/ul>
&lt;ul>
&lt;li>
&lt;p>You can find the oscdimg.exe in the Windows 11 22h2 ADK:&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install"target="_blank" rel="noopener">https://learn.microsoft.com/en-us/windows-hardware/get-started/adk-install&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Kit &amp;ldquo;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\arm64\Oscdimg&amp;rdquo;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$global:oscdimgPath = &amp;ldquo;$global:StartupFolder\tools\oscdimg.exe&amp;rdquo;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>#Template location&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$global:template = &amp;ldquo;$global:StartupFolder\template&amp;rdquo;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>#template vhd name / windows is sysprep / Ubuntu cloud-init / modify for your template.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$global:2022core = &amp;ldquo;W2022C.vhdx&amp;rdquo;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$global:2022stand = &amp;ldquo;W2022S_OS.vhdx&amp;rdquo;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$global:2022data = &amp;ldquo;W2022D_OS.vhdx&amp;rdquo;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$global:Ubuntu = &amp;ldquo;Ubuntu_OS.vhd&amp;rdquo;&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://github.com/Lubenz007/hyper-v-tool/assets/116028026/1e961bfd-aa70-41c3-96dd-6740f175d03b" alt="image" loading="lazy" />
&lt;img src="https://github.com/Lubenz007/hyper-v-tool/assets/116028026/24f16f37-738a-4a17-a990-238896e9bcb3" alt="image" loading="lazy" />
&lt;img src="https://github.com/Lubenz007/hyper-v-tool/assets/116028026/ac87298b-dd9d-4d1c-8d06-3db92c6105bf" alt="image" loading="lazy" />
&lt;img src="https://github.com/Lubenz007/hyper-v-tool/assets/116028026/817222df-cee3-40ee-8a39-740abea0b3d5" alt="image" loading="lazy" />
&lt;img src="https://github.com/Lubenz007/hyper-v-tool/assets/116028026/4e5d853f-7b6e-47ef-9827-2b0f67573578" alt="image" loading="lazy" />
&lt;img src="https://github.com/Lubenz007/hyper-v-tool/assets/116028026/9ec272c6-86e3-4c96-8b13-41ae1f15b132" alt="image" loading="lazy" />
&lt;img src="https://github.com/Lubenz007/hyper-v-tool/assets/116028026/b69fe441-64d9-4d7a-85b6-c7e80df0796a" alt="image" loading="lazy" />&lt;/p></description></item><item><title>Get Azure Defender for Cloud score Via API</title><link>https://lubenz007.github.io/bensiegils/posts/2023-05-28-defendercloudesecurescore-/</link><pubDate>Sun, 28 May 2023 14:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-05-28-defendercloudesecurescore-/</guid><description>
&lt;p>Create detailed reports of Azure Defender for Cloud security scores using API calls and export them to CSV format for sharing and progress tracking.&lt;/p>
&lt;h2>Azure Defender Security Score Reporting&lt;span class="hx:absolute hx:-mt-20" id="azure-defender-security-score-reporting">&lt;/span>
&lt;a href="#azure-defender-security-score-reporting" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>How to build a report of Azure Defender for Cloud score via API, and export it to CSV. Why do we need this? Share it with your stakeholders and show them the progress of your security posture.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Info:&lt;/strong> Need to create service principal with the following permissions: Read RBAC on each subscription.&lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#set the variables&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientID = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientSecret = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$tenant_Id = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># your subscription Ids&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$subscription_Ids = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Create the body of the request.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Grant_Type = &lt;span style="color:#e6db74">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Resource = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_id = $clientId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_secret = $clientSecret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ConnectGraph = Invoke-RestMethod -Uri &lt;span style="color:#e6db74">&amp;#34;https://login.microsoft.com/&lt;/span>$tenant_Id&lt;span style="color:#e6db74">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> -Method POST -Body $Body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Content-Type&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$($ConnectGraph.access_token)&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Net.ServicePointManager&lt;/span>]::SecurityProtocol = [&lt;span style="color:#66d9ef">Net.SecurityProtocolType&lt;/span>]::Tls12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#function to get graph data with pagination&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> Get-GraphData {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">param&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$AccessToken,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$Uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$AccessToken&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $QueryResults += $Results.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Uri = $Results.&lt;span style="color:#e6db74">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> ($Uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> $QueryResults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Get the data&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">foreach&lt;/span> ($subscription_Id &lt;span style="color:#66d9ef">in&lt;/span> $subscription_Ids) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $uri1 = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>$subscription_Id&lt;span style="color:#e6db74">/providers/Microsoft.Security/secureScores?api-version=2020-01-01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">array&lt;/span>]$secureScores = Get-GraphData -AccessToken $ConnectGraph.access_token -Uri $uri1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $uri2 = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>$subscription_Id&lt;span style="color:#e6db74">/providers/Microsoft.Security/secureScores/ascScore/securescorecontrols?api-version=2020-01-01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">array&lt;/span>]$ascScores = Get-GraphData -AccessToken $ConnectGraph.access_token -Uri $uri2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $uri3 = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>$subscription_Id&lt;span style="color:#e6db74">/providers/Microsoft.Security/secureScoreControlDefinitions?api-version=2020-01-01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">array&lt;/span>]$secureScoreControlDefinitions = Get-GraphData -AccessToken $ConnectGraph.access_token -Uri $uri3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $uri4 = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>$subscription_Id&lt;span style="color:#e6db74">/providers/Microsoft.Security/assessments?api-version=2020-01-01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">array&lt;/span>]$assessments = Get-GraphData -AccessToken $ConnectGraph.access_token -Uri $uri4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $uri5 = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>$subscription_Id&lt;span style="color:#e6db74">/providers/Microsoft.Security/secureScores/ascScore/securescorecontrols?api-version=2020-01-01&amp;amp;expand=definition&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">array&lt;/span>]$securescorecontrols = Get-GraphData -AccessToken $ConnectGraph.access_token -Uri $uri5
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Create the report&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ReportLineScore = [&lt;span style="color:#66d9ef">PSCustomObject][Ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MaxScore = $secureScores.Properties.score.max
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Current = $secureScores.Properties.score.current
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> percentage = $secureScores.Properties.score.percentage * &lt;span style="color:#ae81ff">100&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData = [&lt;span style="color:#66d9ef">System.Collections.Generic.List[Object]&lt;/span>]::new()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ForEach&lt;/span> ($ascScore &lt;span style="color:#66d9ef">in&lt;/span> $ascScores) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPLine = [&lt;span style="color:#66d9ef">PSCustomObject][Ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name = $ascScore.properties.displayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Healthy = $ascScore.properties.healthyResourceCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UnHealthy = $ascScore.properties.unhealthyResourceCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NotApplicable = $ascScore.properties.notApplicableResourceCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> weight = $ascScore.properties.weight
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> maxScore = $ascScore.properties.score.max
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> currentScore = $ascScore.properties.score.current
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> percentage = $ascScore.properties.score.percentage * &lt;span style="color:#ae81ff">100&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPData.Add($SPLine)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData1 = [&lt;span style="color:#66d9ef">System.Collections.Generic.List[Object]&lt;/span>]::new()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">foreach&lt;/span> ($secureScoreControlDefinition &lt;span style="color:#66d9ef">in&lt;/span> $secureScoreControlDefinitions) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPLine1 = [&lt;span style="color:#66d9ef">PSCustomObject][Ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name = $secureScoreControlDefinition.properties.displayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MaxScore = $secureScoreControlDefinition.properties.maxScore
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPData1.Add($SPLine1)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData2 = [&lt;span style="color:#66d9ef">System.Collections.Generic.List[Object]&lt;/span>]::new()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">foreach&lt;/span> ($assessment &lt;span style="color:#66d9ef">in&lt;/span> $assessments) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPLine2 = [&lt;span style="color:#66d9ef">PSCustomObject][Ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name = $assessment.properties.displayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Status = $assessment.properties.status.description
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Code = $assessment.properties.status.code
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Cause = $assessment.properties.status.cause
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Details = $assessment.properties.resourceDetails.Id
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPData2.Add($SPLine2)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData3 = [&lt;span style="color:#66d9ef">System.Collections.Generic.List[Object]&lt;/span>]::new()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">foreach&lt;/span> ($securescorecontrol &lt;span style="color:#66d9ef">in&lt;/span> $securescorecontrols) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPLine3 = [&lt;span style="color:#66d9ef">PSCustomObject][Ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name = $securescorecontrol.properties.displayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> HealthyCount = $securescorecontrol.properties.healthyResourceCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UnHealthyCount = $securescorecontrol.properties.unhealthyResourceCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NotApplicableCount = $securescorecontrol.properties.notApplicableResourceCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPData3.Add($SPLine3)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ReportLineScore | Export-Csv -Path &lt;span style="color:#e6db74">&amp;#34;c:\temp\ReportLineScore.csv&amp;#34;&lt;/span> -NoTypeInformation -Encoding UTF8
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData | Export-Csv -Path &lt;span style="color:#e6db74">&amp;#34;c:\temp\SPData.csv&amp;#34;&lt;/span> -NoTypeInformation -Encoding UTF8
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData1 | Export-Csv -Path &lt;span style="color:#e6db74">&amp;#34;c:\temp\SPData1.csv&amp;#34;&lt;/span> -NoTypeInformation -Encoding UTF8
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData2 | Export-Csv -Path &lt;span style="color:#e6db74">&amp;#34;c:\temp\SPData2.csv&amp;#34;&lt;/span> -NoTypeInformation -Encoding UTF8
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData3 | Export-Csv -Path &lt;span style="color:#e6db74">&amp;#34;c:\temp\SPData3.csv&amp;#34;&lt;/span> -NoTypeInformation -Encoding UTF8&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">MaxScore&lt;/th>
&lt;th style="text-align: left">Current&lt;/th>
&lt;th style="text-align: left">percentage&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">31&lt;/td>
&lt;td style="text-align: left">24&lt;/td>
&lt;td style="text-align: left">77,42&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">Name&lt;/th>
&lt;th style="text-align: left">MaxScore&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">Protect applications against DDoS attacks&lt;/td>
&lt;td style="text-align: left">2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Enable MFA&lt;/td>
&lt;td style="text-align: left">10&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Encrypt data in transit&lt;/td>
&lt;td style="text-align: left">4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Restrict unauthorized network access&lt;/td>
&lt;td style="text-align: left">4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Implement security best practices&lt;/td>
&lt;td style="text-align: left">0&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Apply adaptive application control&lt;/td>
&lt;td style="text-align: left">3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Enable auditing and logging&lt;/td>
&lt;td style="text-align: left">1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Enable encryption at rest&lt;/td>
&lt;td style="text-align: left">4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Enable endpoint protection&lt;/td>
&lt;td style="text-align: left">2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Apply system updates&lt;/td>
&lt;td style="text-align: left">6&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Manage access and permissions&lt;/td>
&lt;td style="text-align: left">4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Remediate security configurations&lt;/td>
&lt;td style="text-align: left">4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Secure management ports&lt;/td>
&lt;td style="text-align: left">8&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Remediate vulnerabilities&lt;/td>
&lt;td style="text-align: left">6&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Enable enhanced security features&lt;/td>
&lt;td style="text-align: left">0&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Monitor Azure Usage for a subscription</title><link>https://lubenz007.github.io/bensiegils/posts/2023-05-17-azureusageresource/</link><pubDate>Sat, 13 May 2023 14:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-05-17-azureusageresource/</guid><description>
&lt;p>Why do we need to monitor Azure usage? Well, if you have a subscription with a spending limit, you need to keep track of your usage. If you go over the spending limit, your resources will be disabled. And you will need to pay for the overage.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Info:&lt;/strong> My concern is that some one gets a hold of my subscription, and start to use it. And I will get a big bill at the end of the month.&lt;/p>
&lt;/blockquote>
&lt;p>Using Get-AzConsumptionUsageDetail to get the usage for a subscription. Works not for Azure Plan subscriptions.
Bcause of this error: ((400) Subscription scope usage is not supported for current api version. Please use api version after 2019-10-01)&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Tip:&lt;/strong> But we can use the Microsoft.Consumption/usageDetails API to get the usage for a subscription.&lt;/p>
&lt;/blockquote>
&lt;p>First we need to create a Service Principal, and we need to give service principal billing role on the subscription.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#This script will get the usage for a subscription&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$startDate = (Get-Date).AddDays(&lt;span style="color:#ae81ff">-2&lt;/span>).ToString(&lt;span style="color:#e6db74">&amp;#34;yyyy-MM-dd&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$endDate = (Get-Date).AddDays(&lt;span style="color:#ae81ff">-1&lt;/span>).ToString(&lt;span style="color:#e6db74">&amp;#34;yyyy-MM-dd&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#set the variables&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientID = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientSecret = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$tenant_Id = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$subscriptionId = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Set the URI for the request.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$uri1 = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>$subscriptionId&lt;span style="color:#e6db74">/providers/Microsoft.Consumption/usageDetails?api-version=2023-03-01&amp;amp;startDate=&lt;/span>${startDate}&lt;span style="color:#e6db74">&amp;amp;endDate=&lt;/span>${startDate}&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$uri2 = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>$subscriptionId&lt;span style="color:#e6db74">/providers/Microsoft.Consumption/usageDetails?api-version=2023-03-01&amp;amp;startDate=&lt;/span>${endDate}&lt;span style="color:#e6db74">&amp;amp;endDate=&lt;/span>${endDate}&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Create the body of the request.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Grant_Type = &lt;span style="color:#e6db74">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Resource = &lt;span style="color:#e6db74">&amp;#34;https://management.azure.com/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_id = $clientId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_secret = $clientSecret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ConnectGraph = Invoke-RestMethod -Uri &lt;span style="color:#e6db74">&amp;#34;https://login.microsoft.com/&lt;/span>$tenant_Id&lt;span style="color:#e6db74">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> -Method POST -Body $Body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Content-Type&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$($ConnectGraph.access_token)&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Net.ServicePointManager&lt;/span>]::SecurityProtocol = [&lt;span style="color:#66d9ef">Net.SecurityProtocolType&lt;/span>]::Tls12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#function to get graph data with pagination&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> Get-GraphData {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">param&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$AccessToken,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$Uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$AccessToken&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $QueryResults += $Results.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Uri = $Results.&lt;span style="color:#e6db74">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> ($Uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> $QueryResults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$useage = Invoke-WebRequest -Method GET -Uri $Uri -ContentType &amp;#34;application/json&amp;#34; -Headers $headers | ConvertFrom-Json&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$uritwodaysago = Get-GraphData -AccessToken $ConnectGraph.access_token -Uri $uri1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$uriyesterday = Get-GraphData -AccessToken $ConnectGraph.access_token -Uri $uri2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Resultstwodaysago = $uritwodaysago | Select-Object -ExpandProperty properties | Measure-Object -Property costInBillingCurrency -Sum | Select-Object Sum
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Resultyesterday = $uriyesterday | Select-Object -ExpandProperty properties | Measure-Object -Property costInBillingCurrency -Sum | Select-Object Sum
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Resultstwodaysago = [&lt;span style="color:#66d9ef">math&lt;/span>]::Floor($Resultstwodaysago.sum)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Resultyesterday = [&lt;span style="color:#66d9ef">math&lt;/span>]::ceiling($Resultyesterday.sum)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$percentof = [&lt;span style="color:#66d9ef">math&lt;/span>]::Floor($Resultstwodaysago * &lt;span style="color:#ae81ff">1.4&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> ($Resultstwodaysago &lt;span style="color:#f92672">-le&lt;/span> $percentof &lt;span style="color:#f92672">-and&lt;/span> $Resultyesterday &lt;span style="color:#f92672">-lt&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Host &lt;span style="color:#e6db74">&amp;#34;OK: Yesterday&amp;#39;s Azure spending (&lt;/span>$Resultyesterday&lt;span style="color:#e6db74"> Euro) is not 40% more than 2 days ago (&lt;/span>$Resultstwodaysago&lt;span style="color:#e6db74"> Euro) and not more than 100 Euro | yesterday=&lt;/span>$Resultyesterday&lt;span style="color:#e6db74">, spending2daysago=&lt;/span>$Resultstwodaysago&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Host &lt;span style="color:#e6db74">&amp;#34;Alarm!! Tom Much Azure Spending&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $webhookUri = &lt;span style="color:#e6db74">&amp;#34;webhook from teams&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;@context&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;http://schema.org/extensions&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;@typecod&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;MessageCard&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;themeColor&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;d70000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;title&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Alarm!! To Much Azure Spending&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;text&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Some thing is wrong in Azure. Yesterday&amp;#39;s Azure spending (&lt;/span>$Resultyesterday&lt;span style="color:#e6db74"> Euro) is 40% more than 2 days ago (&lt;/span>$Resultstwodaysago&lt;span style="color:#e6db74"> Euro) or more than 100 Euro&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Invoke-RestMethod -Uri $webhookUri -Method Post -Body (ConvertTo-Json -InputObject $body)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>Monitor Azure usage with github actions</title><link>https://lubenz007.github.io/bensiegils/posts/2023-05-13-azureusage/</link><pubDate>Sat, 13 May 2023 14:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-05-13-azureusage/</guid><description>
&lt;blockquote>
&lt;p>This will not work for Azure Plan subscriptions.
((400) Subscription scope usage is not supported for current api version. Please use api version after 2019-10-01)
{: .prompt-info }&lt;/p>
&lt;/blockquote>
&lt;h3>Need to keep track of your Azure usage? here is a way to use github actions to keep track of your usage. And send you a Teams message if you are over a certain amount.&lt;span class="hx:absolute hx:-mt-20" id="need-to-keep-track-of-your-azure-usage-here-is-a-way-to-use-github-actions-to-keep-track-of-your-usage-and-send-you-a-teams-message-if-you-are-over-a-certain-amount">&lt;/span>
&lt;a href="#need-to-keep-track-of-your-azure-usage-here-is-a-way-to-use-github-actions-to-keep-track-of-your-usage-and-send-you-a-teams-message-if-you-are-over-a-certain-amount" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>We will need to enable webhook in Teams and add the webhook to the script, and create a Service Principal with access to the subscription you want to monitor.
{: .prompt-tip }&lt;/p>
&lt;/blockquote>
&lt;p>Create Service Principal and give it access to the subscription you want to monitor.
Copy the output from the command below and add it to the github repository as a secret, AZURE_CREDENTIALS.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>az ad sp create-for-rbac --name &lt;span style="color:#e6db74">&amp;#34;AzureUsage&amp;#34;&lt;/span> --role contributor --scopes /subscriptions/0692777c --sdk-auth&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/azurelogin.png" alt="Desktop View" loading="lazy" />{: .normal-image}&lt;/p>
&lt;blockquote>
&lt;p>We will need to add secret to the repository, AZURE_CREDENTIALS, and add the output from the command above.
{: .prompt-tip }
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/gitsecret.png" alt="Desktop View" loading="lazy" />{: .normal-image}&lt;/p>
&lt;/blockquote>
&lt;p>Github actions, it runs every day at midnight.&lt;/p>
&lt;ul>
&lt;li>cron: &amp;lsquo;0 0 * * *&amp;rsquo; # every day at midnight&lt;/li>
&lt;/ul>
&lt;p>This is the workflow file&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># File: .github/workflows/workflow.yml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">on&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">schedule&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">cron&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;0 0 * * *&amp;#39;&lt;/span> &lt;span style="color:#75715e"># every day at midnight&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">AzureUsage&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">jobs&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">build-and-deploy&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">runs-on&lt;/span>: &lt;span style="color:#ae81ff">ubuntu-latest&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">steps&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">uses&lt;/span>: &lt;span style="color:#ae81ff">azure/login@v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">with&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">creds&lt;/span>: &lt;span style="color:#ae81ff">${{ secrets.AZURE_CREDENTIALS }}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">enable-AzPSSession&lt;/span>: &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">Run Azure PowerShell script&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">uses&lt;/span>: &lt;span style="color:#ae81ff">azure/powershell@v1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">with&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">inlinescript&lt;/span>: |&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $startDate = (Get-Date).AddDays(-2).ToString(&amp;#34;yyyy-MM-dd&amp;#34;)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $endDate = (Get-Date).AddDays(-1).ToString(&amp;#34;yyyy-MM-dd&amp;#34;)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $twodaysago = Get-AzConsumptionUsageDetail -StartDate $startDate -EndDate $startDate | Measure-Object -Property PretaxCost -Sum | Select-Object Sum
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $yesterday = Get-AzConsumptionUsageDetail -StartDate $enddate -EndDate $enddate | Measure-Object -Property PretaxCost -Sum | Select-Object Sum
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $twodaysago = [math]::Floor($twodaysago.sum)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $yesterday = [math]::ceiling($yesterday.sum)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $percentof = [math]::Floor($twodaysago * 1.4)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> if ($twodaysago -le $percentof -and $yesterday -lt 100) {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> Write-Host &amp;#34;OK: Yesterday&amp;#39;s Azure spending ($yesterday Euro) is not 40% more than 2 days ago ($twodaysago Euro) and not more than 100 Euro | yesterday=$yesterday, spending2daysago=$twodaysago&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> else
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> {
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> Write-Host &amp;#34;Alarm!! Tom Much Azure Spending&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $webhookUri = &amp;#34;webhook from teams&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> $body = @{
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;@context&amp;#34; = &amp;#34;http://schema.org/extensions&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;@typecod&amp;#34; = &amp;#34;MessageCard&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;themeColor&amp;#34; = &amp;#34;d70000&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;title&amp;#34; = &amp;#34;Alarm!! To Much Azure Spending&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;text&amp;#34; = &amp;#34;Some thing is wrong in Azure. Yesterday&amp;#39;s Azure spending ($yesterday Euro) is 40% more than 2 days ago ($twodaysago Euro) or more than 100 Euro&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> Invoke-RestMethod -Uri $webhookUri -Method Post -Body (ConvertTo-Json -InputObject $body)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> }&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">azPSVersion&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;latest&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/AzureCred.png" alt="Desktop View" loading="lazy" />
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/spending.png" alt="Desktop View" loading="lazy" />&lt;/p></description></item><item><title>Three great tools for Azure</title><link>https://lubenz007.github.io/bensiegils/posts/2023-05-10-three-tool/</link><pubDate>Wed, 10 May 2023 22:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-05-10-three-tool/</guid><description>
&lt;p>Always in need of great tools to enhance Azure management and visualization. Here are three powerful tools that can help streamline your Azure operations.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://github.com/Azure/azqr"target="_blank" rel="noopener">Azure Quick Review&lt;/a>
Azure Quick Review (azqr) goal is to produce a high level assessment of an Azure Subscription or Resource Group providing the following information for each Azure Service.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/PrateekKumarSingh/AzViz"target="_blank" rel="noopener">Azure Visualizer&lt;/a>
PowerShell module to automatically generate Azure resource topology diagrams by just typing a PowerShell cmdlet and passing the name of one or more Azure Resource Group(s).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/mivano/azure-cost-cli"target="_blank" rel="noopener">Azure Cost CLI&lt;/a>
simple command line tool to get the cost of your Azure subscription.&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Azure Cost CLI</title><link>https://lubenz007.github.io/bensiegils/posts/2023-05-03-azure-cost-cli/</link><pubDate>Wed, 03 May 2023 20:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-05-03-azure-cost-cli/</guid><description>
&lt;p>Azure-Cost-CLI is a powerful tool to get cost information from Azure directly from the command line. &lt;a href="https://github.com/mivano/azure-cost-cli"target="_blank" rel="noopener">GitHub Repository&lt;/a>&lt;/p>
&lt;h2>Benefits of This Tool&lt;span class="hx:absolute hx:-mt-20" id="benefits-of-this-tool">&lt;/span>
&lt;a href="#benefits-of-this-tool" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>Get cost information without logging into the Azure portal&lt;/li>
&lt;li>Send Teams messages with cost information&lt;/li>
&lt;li>Send emails with cost reports&lt;/li>
&lt;li>Perfect for automation and scheduled reporting&lt;/li>
&lt;/ul>
&lt;h1>Azure Cost Overview&lt;/h1>&lt;blockquote class="white">
Accumulated cost for subscription id `0692777c-ed93-4a6a-85c7-144c24xxxx` from **1.5.2023** to **9.5.2023**
&lt;/blockquote>
&lt;h2>Totals&lt;span class="hx:absolute hx:-mt-20" id="totals">&lt;/span>
&lt;a href="#totals" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Period&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Today&lt;/td>
&lt;td style="text-align: right">0,90 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Yesterday&lt;/td>
&lt;td style="text-align: right">2,21 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Last 7 days&lt;/td>
&lt;td style="text-align: right">17,26 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Last 30 days&lt;/td>
&lt;td style="text-align: right">19,40 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
gantt
title Accumulated cost
dateFormat X
axisFormat %s
section 01 maÃ­
EUR 2,14 :0, 214
section 02 maÃ­
EUR 4,24 :0, 424
section 03 maÃ­
EUR 6,37 :0, 637
section 04 maÃ­
EUR 8,51 :0, 851
section 05 maÃ­
EUR 11,00 :0, 1100
section 06 maÃ­
EUR 13,61 :0, 1361
section 07 maÃ­
EUR 16,29 :0, 1629
section 08 maÃ­
EUR 18,50 :0, 1850
section 09 maÃ­
EUR 19,40 :0, 1940
section 10 maÃ­
EUR 21,36 : done, 0, 2136
section 11 maÃ­
EUR 23,33 : done, 0, 2333
section 12 maÃ­
EUR 25,52 : done, 0, 2552
section 13 maÃ­
EUR 27,71 : done, 0, 2771
section 14 maÃ­
EUR 30,04 : done, 0, 3004
section 15 maÃ­
EUR 32,19 : done, 0, 3219
section 16 maÃ­
EUR 34,08 : done, 0, 3408
section 17 maÃ­
EUR 35,99 : done, 0, 3599
section 18 maÃ­
EUR 37,91 : done, 0, 3791
section 19 maÃ­
EUR 40,04 : done, 0, 4004
section 20 maÃ­
EUR 42,18 : done, 0, 4218
section 21 maÃ­
EUR 44,46 : done, 0, 4446
section 22 maÃ­
EUR 46,54 : done, 0, 4654
section 23 maÃ­
EUR 48,39 : done, 0, 4839
section 24 maÃ­
EUR 50,24 : done, 0, 5024
section 25 maÃ­
EUR 52,10 : done, 0, 5210
section 26 maÃ­
EUR 54,18 : done, 0, 5418
section 27 maÃ­
EUR 56,26 : done, 0, 5626
section 28 maÃ­
EUR 58,48 : done, 0, 5848
section 29 maÃ­
EUR 60,51 : done, 0, 6051
section 30 maÃ­
EUR 62,30 : done, 0, 6230
section 31 maÃ­
EUR 64,10 : done, 0, 6410
&lt;/pre>&lt;h2>By Service Name&lt;span class="hx:absolute hx:-mt-20" id="by-service-name">&lt;/span>
&lt;a href="#by-service-name" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Service&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Backup&lt;/td>
&lt;td style="text-align: right">21,92 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Security Center&lt;/td>
&lt;td style="text-align: right">9,88 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Azure App Service&lt;/td>
&lt;td style="text-align: right">2,52 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Virtual Network&lt;/td>
&lt;td style="text-align: right">1,40 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Log Analytics&lt;/td>
&lt;td style="text-align: right">1,21 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Sentinel&lt;/td>
&lt;td style="text-align: right">1,00 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Azure DNS&lt;/td>
&lt;td style="text-align: right">0,52 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Storage&lt;/td>
&lt;td style="text-align: right">0,31 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Advanced Threat Protection&lt;/td>
&lt;td style="text-align: right">0,04 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Others&lt;/td>
&lt;td style="text-align: right">0,00 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
pie
title Cost by service
&amp;#34;Backup&amp;#34; : 21.92
&amp;#34;Security Center&amp;#34; : 9.88
&amp;#34;Azure App Service&amp;#34; : 2.52
&amp;#34;Virtual Network&amp;#34; : 1.40
&amp;#34;Log Analytics&amp;#34; : 1.21
&amp;#34;Sentinel&amp;#34; : 1.00
&amp;#34;Azure DNS&amp;#34; : 0.52
&amp;#34;Storage&amp;#34; : 0.31
&amp;#34;Advanced Threat Protection&amp;#34; : 0.04
&amp;#34;Others&amp;#34; : 0.00
&lt;/pre>&lt;h2>By Location&lt;span class="hx:absolute hx:-mt-20" id="by-location">&lt;/span>
&lt;a href="#by-location" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Location&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>EU West&lt;/td>
&lt;td style="text-align: right">8,23 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Unassigned&lt;/td>
&lt;td style="text-align: right">4,96 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>US West&lt;/td>
&lt;td style="text-align: right">4,07 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>EU North&lt;/td>
&lt;td style="text-align: right">1,88 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Unknown&lt;/td>
&lt;td style="text-align: right">0,26 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
pie
title Cost by location
&amp;#34;EU West&amp;#34; : 8.23
&amp;#34;Unassigned&amp;#34; : 4.96
&amp;#34;US West&amp;#34; : 4.07
&amp;#34;EU North&amp;#34; : 1.88
&amp;#34;Unknown&amp;#34; : 0.26
&lt;/pre>&lt;h2>By Resource Group&lt;span class="hx:absolute hx:-mt-20" id="by-resource-group">&lt;/span>
&lt;a href="#by-resource-group" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Resource Group&lt;/th>
&lt;th style="text-align: right">Amount&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>bensa&lt;/td>
&lt;td style="text-align: right">6,80 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>microsoft.security&lt;/td>
&lt;td style="text-align: right">4,96 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>backuptest&lt;/td>
&lt;td style="text-align: right">4,07 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>alitis&lt;/td>
&lt;td style="text-align: right">2,22 EUR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>test2&lt;/td>
&lt;td style="text-align: right">1,35 EUR&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;pre class="mermaid hx:mt-6">
pie
title Cost by resource group
&amp;#34;bensa&amp;#34; : 6.80
&amp;#34;microsoft.security&amp;#34; : 4.96
&amp;#34;backuptest&amp;#34; : 4.07
&amp;#34;alitis&amp;#34; : 2.22
&amp;#34;test2&amp;#34; : 1.35
&lt;/pre>&lt;p>&lt;sup>Generated at 2023-05-09 23:33:20&lt;/sup>&lt;/p></description></item><item><title>Getting old guest accounts in Azure AD</title><link>https://lubenz007.github.io/bensiegils/posts/2023-04-26-old-guest-accounts/</link><pubDate>Wed, 26 Apr 2023 23:00:49 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-04-26-old-guest-accounts/</guid><description>
&lt;p>This is a rewrite from &lt;a href="https://office365itpros.com/2019/10/15/report-old-guest-accounts/"target="_blank" rel="noopener">here&lt;/a> office365itpros.com
I have added some more properties to the report.
And use msgraph instead of mggraph.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Needs permission User.Read.All&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientID = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientSecret = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$tenant_Id = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Connect to Graph #&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Grant_Type = &lt;span style="color:#e6db74">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resource = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_id = $clientId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_secret = $clientSecret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ConnectGraph = Invoke-RestMethod -Uri &lt;span style="color:#e6db74">&amp;#34;https://login.microsoft.com/&lt;/span>$tenant_Id&lt;span style="color:#e6db74">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> -Method POST -Body $Body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Variable Collections #&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Content-Type&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$($ConnectGraph.access_token)&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$token = $ConnectGraph.access_token
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Net.ServicePointManager&lt;/span>]::SecurityProtocol = [&lt;span style="color:#66d9ef">Net.SecurityProtocolType&lt;/span>]::Tls12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> Get-GraphData {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">param&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$AccessToken,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$Uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$AccessToken&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $QueryResults += $Results.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Uri = $Results.&lt;span style="color:#e6db74">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> ($Uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> $QueryResults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#This request get users list with signInActivity.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$uri = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com/beta/users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Result = @()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">array&lt;/span>]$Response = Get-GraphData -AccessToken $Token -Uri $uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> ($Response) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">ForEach&lt;/span> ($Respons &lt;span style="color:#66d9ef">in&lt;/span> $Response) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Result += New-Object PSObject -property $([&lt;span style="color:#66d9ef">ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> DisplayName = $Respons.displayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UserPrincipalName = $Respons.userPrincipalName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UsageLocation = $Respons.usageLocation
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Contry = $Respons.country
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LastSignInDateTime = &lt;span style="color:#66d9ef">if&lt;/span>($Respons.signInActivity.lastSignInDateTime) { [&lt;span style="color:#66d9ef">DateTime&lt;/span>]$Respons.signInActivity.lastSignInDateTime } &lt;span style="color:#66d9ef">Else&lt;/span> {$null}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> IsLicensed = &lt;span style="color:#66d9ef">if&lt;/span> ($Respons.assignedLicenses.Count &lt;span style="color:#f92672">-ne&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) { $true } &lt;span style="color:#66d9ef">else&lt;/span> { $false }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> IsGuestUser = &lt;span style="color:#66d9ef">if&lt;/span> ($Respons.userType &lt;span style="color:#f92672">-eq&lt;/span> &lt;span style="color:#e6db74">&amp;#39;Guest&amp;#39;&lt;/span>) { $true } &lt;span style="color:#66d9ef">else&lt;/span> { $false }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RefreshTokensValidFromDateTime = $Respons.RefreshTokensValidFromDateTime
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> onPremisesDistinguishedName = $Respons.onPremisesDistinguishedName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Host &lt;span style="color:#e6db74">&amp;#34;No User data found&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$GuestUsers = $Result | Where-Object{$_.IsGuestUser &lt;span style="color:#f92672">-eq&lt;/span> &lt;span style="color:#e6db74">&amp;#34;TRUE&amp;#34;&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$GuestAccountAge = &lt;span style="color:#ae81ff">365&lt;/span> &lt;span style="color:#75715e"># Value used for guest age comparison. If you want this to be a different value (like 30 days), change this here.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$GuestUsers = $users.value -All $true -Filter &amp;#34;UserType eq &amp;#39;Guest&amp;#39;&amp;#34; | Sort DisplayName&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Today = (Get-Date); $StaleGuests = &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Report = [&lt;span style="color:#66d9ef">System.Collections.Generic.List[Object]&lt;/span>]::new()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Check each account and find those over 365 days old&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ForEach&lt;/span> ($Guest &lt;span style="color:#66d9ef">in&lt;/span> $GuestUsers) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $AADAccountAge = ($Guest.RefreshTokensValidFromDateTime | New-TimeSpan).Days
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">If&lt;/span> ($AADAccountAge &lt;span style="color:#f92672">-gt&lt;/span> $GuestAccountAge) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $StaleGuests++
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#Write-Host &amp;#34;Processing&amp;#34; $Guest.DisplayName&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $i = &lt;span style="color:#ae81ff">0&lt;/span>; $GroupNames = $Null
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Find what Microsoft 365 Groups the guest belongs to... if any&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $ReportLine = [&lt;span style="color:#66d9ef">PSCustomObject&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UPN = $Guest.UserPrincipalName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Name = $Guest.DisplayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Age = $AADAccountAge
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Created = $Guest.RefreshTokensValidFromDateTime
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Report.Add($ReportLine) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Output the report&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Report | Sort Age -Descending | Format-Table -AutoSize
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Write-Host &lt;span style="color:#e6db74">&amp;#34;Found&amp;#34;&lt;/span> $StaleGuests &lt;span style="color:#e6db74">&amp;#34;stale guest accounts.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#reference: https://office365itpros.com/2019/10/15/report-old-guest-accounts/&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>Getting started with Terraform and Azure</title><link>https://lubenz007.github.io/bensiegils/posts/2023-04-22-aztfexport/</link><pubDate>Sat, 22 Apr 2023 18:46:49 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-04-22-aztfexport/</guid><description>
&lt;p>Get started with Terraform and Azure by exporting existing infrastructure using aztfexport. This Azure-specific tool makes it easy to convert your current Azure resources into Terraform templates.&lt;/p>
&lt;p>I like to watch videos on how to do things, but I don&amp;rsquo;t like to start from scratch. I prefer having a template to start and test things out. That&amp;rsquo;s why I looked into exporting Azure configurations to templates. While Terraformer can export existing cloud infrastructure to Terraform code, I prefer aztfexport because it&amp;rsquo;s more Azure-specific.&lt;/p>
&lt;h2>Install aztfexport is easy from package manager&lt;span class="hx:absolute hx:-mt-20" id="install-aztfexport-is-easy-from-package-manager">&lt;/span>
&lt;a href="#install-aztfexport-is-easy-from-package-manager" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>c:\winget install aztfexport&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>And we need also Azure Cli&lt;span class="hx:absolute hx:-mt-20" id="and-we-need-also-azure-cli">&lt;/span>
&lt;a href="#and-we-need-also-azure-cli" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>c:\winget install azure-cli&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>Login to Azure&lt;span class="hx:absolute hx:-mt-20" id="login-to-azure">&lt;/span>
&lt;a href="#login-to-azure" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>This was the part I struggled with: where is the config file? It was too simple: login to Azure with Azure Cli and then select the subscription I wanted to export from. Terraform, Terraformer, and aztfexport will use the same subscription as Azure Cli.&lt;/p>
&lt;blockquote>
&lt;p>So if you try to export and it fails to run, you need to login to Azure Cli.
{: .prompt-tip }&lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>c:\az login&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>Select subscription&lt;span class="hx:absolute hx:-mt-20" id="select-subscription">&lt;/span>
&lt;a href="#select-subscription" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>c:\az account list -o table
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>c:\az account set --subscription &lt;span style="color:#e6db74">&amp;#34;MySubscription&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>Export to Terraform&lt;span class="hx:absolute hx:-mt-20" id="export-to-terraform">&lt;/span>
&lt;a href="#export-to-terraform" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>So I start with a simple resource group.
And export it to Terraform&amp;rsquo;s current folder.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>c:\dashboard\aztfexport rg Dashboard&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>There will be a menu list, and we will use w to import Terraform files.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/terra1.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;h2>Result is a Terraform files&lt;span class="hx:absolute hx:-mt-20" id="result-is-a-terraform-files">&lt;/span>
&lt;a href="#result-is-a-terraform-files" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>So we can start from there and try out things.
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/terra2.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>The first is to test if the Terraform plan works.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>c:\dashboard\terraform plan&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/terra3.png" alt="Desktop View" loading="lazy" />{: .normal-image}
Bingo, the plan works, so we can start to add more resources to the Terraform files.&lt;/p></description></item><item><title>Apps Expiration Azure AD</title><link>https://lubenz007.github.io/bensiegils/posts/2023-04-07-apps-exp/</link><pubDate>Fri, 07 Apr 2023 10:34:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-04-07-apps-exp/</guid><description>
&lt;p>Monitor Azure AD application registrations for expiring certificates and secrets to prevent service disruptions. This script identifies expiring, expired, and apps with no expiration dates.&lt;/p>
&lt;h2>Azure AD Application Expiration Monitoring&lt;span class="hx:absolute hx:-mt-20" id="azure-ad-application-expiration-monitoring">&lt;/span>
&lt;a href="#azure-ad-application-expiration-monitoring" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>This script will check all registered apps in Azure AD and will return the following information: expiring apps, expired apps, and apps with no expiration date.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># needs permission Application.Read.All,Directory.Read.All&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientID = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientSecret = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$tenant_Id = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$TenantName =
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Grant_Type = &lt;span style="color:#e6db74">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resource = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_id = $clientId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_secret = $clientSecret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ConnectGraph = Invoke-RestMethod -Uri &lt;span style="color:#e6db74">&amp;#34;https://login.microsoft.com/&lt;/span>$tenant_Id&lt;span style="color:#e6db74">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> -Method POST -Body $Body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Variable Collections #&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$path = &lt;span style="color:#e6db74">&amp;#34;C:\temp\&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$today = Get-Date
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Content-Type&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$($ConnectGraph.access_token)&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$token = $ConnectGraph.access_token
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Net.ServicePointManager&lt;/span>]::SecurityProtocol = [&lt;span style="color:#66d9ef">Net.SecurityProtocolType&lt;/span>]::Tls12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> Get-GraphData {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">param&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$AccessToken,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$Uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$AccessToken&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $QueryResults += $Results.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Uri = $Results.&lt;span style="color:#e6db74">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> ($Uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> $QueryResults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#This request get application info&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$uri = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com/beta/applications/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">array&lt;/span>]$apps = Get-GraphData -AccessToken $Token -Uri $uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$credentials = @()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> ($apps) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">foreach&lt;/span> ($app &lt;span style="color:#66d9ef">in&lt;/span> $apps) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $ApiUrl = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com/beta/applications/&amp;#34;&lt;/span>+$app.id+&lt;span style="color:#e6db74">&amp;#34;/owners&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $owner = Invoke-WebRequest -Method GET -Uri $ApiUrl -ContentType &lt;span style="color:#e6db74">&amp;#34;application/json&amp;#34;&lt;/span> -Headers $headers | ConvertFrom-Json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $app.KeyCredentials | foreach-object {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#write-host $_.KeyId $_.DisplayName&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $credentials += [&lt;span style="color:#66d9ef">PSCustomObject&lt;/span>] @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CredentialType = &lt;span style="color:#e6db74">&amp;#34;KeyCredentials&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> DisplayName = $app.DisplayName;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> AppId = $app.AppId;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ExpiryDate = $_.EndDateTime;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StartDate = $_.StartDateTime;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#KeyID = $_.KeyId;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Type = $_.Type;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Usage = $_.Usage;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Owners = $owner.value.userPrincipalName;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Expired = (([&lt;span style="color:#66d9ef">DateTime&lt;/span>]$_.EndDateTime) &lt;span style="color:#f92672">-lt&lt;/span> $today) ? &lt;span style="color:#e6db74">&amp;#34;Yes&amp;#34;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;No&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $app.PasswordCredentials | foreach-object {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#write-host $_.KeyId $_.DisplayName&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $credentials += [&lt;span style="color:#66d9ef">PSCustomObject&lt;/span>] @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CredentialType = &lt;span style="color:#e6db74">&amp;#34;PasswordCredentials&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> DisplayName = $app.DisplayName;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> AppId = $app.AppId;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ExpiryDate = $_.EndDateTime;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StartDate = $_.StartDateTime;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">#KeyID = $_.KeyId;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Type = &lt;span style="color:#e6db74">&amp;#39;NA&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Usage = &lt;span style="color:#e6db74">&amp;#39;NA&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Owners = $owner.value.userPrincipalName;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Expired = (([&lt;span style="color:#66d9ef">DateTime&lt;/span>]$_.EndDateTime) &lt;span style="color:#f92672">-lt&lt;/span> $today) ? &lt;span style="color:#e6db74">&amp;#34;Yes&amp;#34;&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;No&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$credentials | Export-Csv -Path $path\credentials.csv -NoTypeInformation
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$credentials | Format-Table | Out-String|ForEach-Object {Write-Host $_}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>&lt;strong>Reference:&lt;/strong> &lt;a href="https://pnp.github.io/script-samples/aad-apps-expired-keys/README.html?tabs=graphps"target="_blank" rel="noopener">https://pnp.github.io/script-samples/aad-apps-expired-keys/README.html?tabs=graphps&lt;/a>&lt;/p>
&lt;/blockquote></description></item><item><title>Powershell Speedtest</title><link>https://lubenz007.github.io/bensiegils/posts/2023-04-06-speedtest/</link><pubDate>Thu, 06 Apr 2023 20:15:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-04-06-speedtest/</guid><description>
&lt;p>Monitor your internet connection performance with this PowerShell script that uses the Speedtest CLI and stores results in Azure Table Storage for historical analysis.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Info:&lt;/strong> The script uses the speedtest CLI from &lt;a href="https://www.speedtest.net/apps/cli"target="_blank" rel="noopener">https://www.speedtest.net/apps/cli&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h2>Problem and Solution&lt;span class="hx:absolute hx:-mt-20" id="problem-and-solution">&lt;/span>
&lt;a href="#problem-and-solution" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Was having problems with my internet connection and wanted to monitor it continuously. So I rewrote this script to use PowerShell and store the results in Azure Table Storage for tracking and analysis.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$StorageAccountName = &amp;#34;StorageAcount&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$Key = &amp;#34;Storagekey&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$StorageContext = New-AzStorageContext -StorageAccountName $StorageAccountName -StorageAccountKey $Key&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$Table = (Get-AzStorageTable -Context $StorageContext | Where-Object {$_.name -eq &amp;#34;Speedtest&amp;#34;}).CloudTable&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$applocation = &lt;span style="color:#e6db74">&amp;#34;C:\apps\speedtest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$path = &lt;span style="color:#e6db74">&amp;#34;C:\temp\&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SpeedTestResults=@()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SpeedtestObj=@()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$i = &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">while&lt;/span> ($i &lt;span style="color:#f92672">-eq&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $PartitionKey = &lt;span style="color:#e6db74">&amp;#34;1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SpeedTestResults = &amp;amp; &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$($applocation)&lt;span style="color:#e6db74">\speedtest.exe&amp;#34;&lt;/span> --progress=no --format=json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SpeedtestResults = $SpeedTestResults | ConvertFrom-Json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SpeedtestObj += [&lt;span style="color:#66d9ef">PSCustomObject&lt;/span>] @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Time = Get-Date -Format &lt;span style="color:#e6db74">&amp;#34;dd/MM/yyyy HH:mm K&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> downloadspeed = [&lt;span style="color:#66d9ef">math&lt;/span>]::Round($SpeedtestResults.download.bandwidth / &lt;span style="color:#ae81ff">1000000&lt;/span> * &lt;span style="color:#ae81ff">8&lt;/span>, &lt;span style="color:#ae81ff">2&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uploadspeed = [&lt;span style="color:#66d9ef">math&lt;/span>]::Round($SpeedtestResults.upload.bandwidth / &lt;span style="color:#ae81ff">1000000&lt;/span> * &lt;span style="color:#ae81ff">8&lt;/span>, &lt;span style="color:#ae81ff">2&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> packetloss = ($($SpeedtestResults.packetLoss).ToString(&lt;span style="color:#e6db74">&amp;#34;P&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> isp = $SpeedtestResults.isp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ExternalIP = $SpeedtestResults.interface.externalIp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> InternalIP = $SpeedtestResults.interface.internalIp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UsedServer = $SpeedtestResults.server.host
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> location = $SpeedTestResults.server.location
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Jitter = [&lt;span style="color:#66d9ef">math&lt;/span>]::Round($SpeedtestResults.ping.jitter)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Latency = [&lt;span style="color:#66d9ef">math&lt;/span>]::Round($SpeedtestResults.ping.latency)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># ---- Move to table storage ----&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Add-AzTableRow -table $Table -PartitionKey $PartitionKey -RowKey (Get-Date).Ticks -property $SpeedtestObj&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Start-Sleep -Seconds &lt;span style="color:#ae81ff">15&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#$SpeedtestObj | Format-Table | Out-String|ForEach-Object {Write-Host $_}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SpeedtestObj | Export-Csv -Path $path\speedtest.csv -NoTypeInformation&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>Esp32 Hot tub controller</title><link>https://lubenz007.github.io/bensiegils/posts/2023-04-04-hottub/</link><pubDate>Tue, 04 Apr 2023 22:15:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-04-04-hottub/</guid><description>
&lt;p>This is my hot tub controller with outdoor shower controller. It is based on an ESP32 and a 4-channel relay module with multiple DS18B20 temperature sensors for comprehensive monitoring.&lt;/p>
&lt;h2>Features&lt;span class="hx:absolute hx:-mt-20" id="features">&lt;/span>
&lt;a href="#features" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>ESP32 microcontroller with 4-channel relay module&lt;/li>
&lt;li>Multiple DS18B20 temperature sensors for hot tub and outdoor shower&lt;/li>
&lt;li>Water temperature monitoring&lt;/li>
&lt;li>ESPHome configuration for Home Assistant integration&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">esphome&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#ae81ff">pottastyring&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">ESP32&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">board&lt;/span>: &lt;span style="color:#ae81ff">nodemcu-32s&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">wifi&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">ssid&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">password&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">domain&lt;/span>: &lt;span style="color:#ae81ff">.lan&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">manual_ip&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">static_ip&lt;/span>: &lt;span style="color:#ae81ff">192.168&lt;/span>&lt;span style="color:#ae81ff">.x.x&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">gateway&lt;/span>: &lt;span style="color:#ae81ff">192.168&lt;/span>&lt;span style="color:#ae81ff">.x.x&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">subnet&lt;/span>: &lt;span style="color:#ae81ff">255.255.255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">dns1&lt;/span>: &lt;span style="color:#ae81ff">192.168&lt;/span>&lt;span style="color:#ae81ff">.x.x&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Enable fallback hotspot (captive portal) in case wifi connection fails&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">ap&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">ssid&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;hottub&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">password&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">captive_portal&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">web_server&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">port&lt;/span>: &lt;span style="color:#ae81ff">80&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Enable logging&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">logger&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Enable Home Assistant API&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">api&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">ota&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">time&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">sntp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">timer&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">servers&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">0.&lt;/span>&lt;span style="color:#ae81ff">pool.ntp.org&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">1.&lt;/span>&lt;span style="color:#ae81ff">pool.ntp.org&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#ae81ff">2.&lt;/span>&lt;span style="color:#ae81ff">pool.ntp.org&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">dallas&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">pin&lt;/span>: &lt;span style="color:#ae81ff">GPIO13&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">sensor&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">dallas&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">address&lt;/span>: &lt;span style="color:#ae81ff">0x67011464EA7EFF28&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Pottur hiti&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">pottur_hiti&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">dallas&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">address&lt;/span>: &lt;span style="color:#ae81ff">0x8B0314649975FF28&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Vatn i pott&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">vatn_i_hiti&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">dallas&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">address&lt;/span>: &lt;span style="color:#ae81ff">0x110000045976f328&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Hiti Skapur&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">Hiti_skapur&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">dallas&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">address&lt;/span>: &lt;span style="color:#ae81ff">0xe10314645814ff28&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Hiti Uti&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">hiti_uti&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">binary_sensor&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">gpio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">filters&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delayed_on&lt;/span>: &lt;span style="color:#ae81ff">100ms&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">fylla&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">pin&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">number&lt;/span>: &lt;span style="color:#ae81ff">GPIO17&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mode&lt;/span>: &lt;span style="color:#ae81ff">INPUT_PULLUP&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">inverted&lt;/span>: &lt;span style="color:#66d9ef">True&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Pottur fylla takki&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">on_press&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">if&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">condition&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">lambda&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;return id(pottur_hiti).state &amp;lt; 20;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">then&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">logger.log&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The sensor value is below 20!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">1min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_4&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">30min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_off&lt;/span>: &lt;span style="color:#ae81ff">relay_1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">3min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">climate.control&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">pottur_climate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mode&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;HEAT&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">logger.log&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The sensor value is above 20!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">gpio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">filters&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delayed_on&lt;/span>: &lt;span style="color:#ae81ff">500ms&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">sturta&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">pin&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">number&lt;/span>: &lt;span style="color:#ae81ff">GPIO21&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mode&lt;/span>: &lt;span style="color:#ae81ff">INPUT_PULLUP&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">inverted&lt;/span>: &lt;span style="color:#66d9ef">True&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Sturta takki&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">on_press&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">if&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">condition&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">lambda&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;return id(pottur_hiti).state &amp;gt; 38;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">then&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">logger.log&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The sensor value is above 38!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">climate.control&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">pottur_climate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mode&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;OFF&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">10sec&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">4min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_off&lt;/span>: &lt;span style="color:#ae81ff">relay_3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">logger.log&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The sensor value is below 20!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">4min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_off&lt;/span>: &lt;span style="color:#ae81ff">relay_3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">gpio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">filters&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delayed_on&lt;/span>: &lt;span style="color:#ae81ff">500ms&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">nidurfall&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">pin&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">number&lt;/span>: &lt;span style="color:#ae81ff">GPIO33&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mode&lt;/span>: &lt;span style="color:#ae81ff">INPUT_PULLUP&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">inverted&lt;/span>: &lt;span style="color:#66d9ef">True&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;taema takki&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">on_press&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">then&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_off&lt;/span>: &lt;span style="color:#ae81ff">relay_4&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">climate.control&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">pottur_climate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">mode&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;off&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">switch&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">gpio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">restore_mode&lt;/span>: &lt;span style="color:#ae81ff">ALWAYS_OFF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Pottur fylla relay&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">pin&lt;/span>: &lt;span style="color:#ae81ff">GPIO25&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">relay_1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">gpio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">restore_mode&lt;/span>: &lt;span style="color:#ae81ff">ALWAYS_OFF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Pottur hita relay&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">pin&lt;/span>: &lt;span style="color:#ae81ff">GPIO26&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">relay_2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">gpio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">restore_mode&lt;/span>: &lt;span style="color:#ae81ff">ALWAYS_OFF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Sturta relay&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">pin&lt;/span>: &lt;span style="color:#ae81ff">GPIO27&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">relay_3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">gpio&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">restore_mode&lt;/span>: &lt;span style="color:#ae81ff">ALWAYS_ON&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Loka nidurfalli&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">pin&lt;/span>: &lt;span style="color:#ae81ff">GPIO18&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">relay_4&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">climate&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">platform&lt;/span>: &lt;span style="color:#ae81ff">bang_bang&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">id&lt;/span>: &lt;span style="color:#ae81ff">pottur_climate&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">visual&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">min_temperature&lt;/span>: &lt;span style="color:#ae81ff">38&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">max_temperature&lt;/span>: &lt;span style="color:#ae81ff">42&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">temperature_step&lt;/span>: &lt;span style="color:#ae81ff">1.0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">name&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;Pottur vatn&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">sensor&lt;/span>: &lt;span style="color:#ae81ff">pottur_hiti&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">default_target_temperature_low&lt;/span>: &lt;span style="color:#ae81ff">38&lt;/span> &lt;span style="color:#ae81ff">Â°C&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">default_target_temperature_high&lt;/span>: &lt;span style="color:#ae81ff">40&lt;/span> &lt;span style="color:#ae81ff">Â°C&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">heat_action&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">if&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">condition&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">lambda&lt;/span>: &lt;span style="color:#e6db74">&amp;#39;return id(pottur_hiti).state &amp;gt; 32;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">then&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">logger.log&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The sensor is above 32! then full&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">logger.log&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;The sensor value is below 32!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">1min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_4&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">delay&lt;/span>: &lt;span style="color:#ae81ff">30min&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_on&lt;/span>: &lt;span style="color:#ae81ff">relay_2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">idle_action&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_off&lt;/span>: &lt;span style="color:#ae81ff">relay_2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#f92672">switch.turn_off&lt;/span>: &lt;span style="color:#ae81ff">relay_1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">mqtt&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">broker&lt;/span>: &lt;span style="color:#ae81ff">192.168&lt;/span>&lt;span style="color:#ae81ff">.x.x&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">username&lt;/span>: &lt;span style="color:#ae81ff">xxx&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">password&lt;/span>: &lt;span style="color:#ae81ff">xxx&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>Upgrade Hyper-V Hosts with Azure Arc</title><link>https://lubenz007.github.io/bensiegils/posts/2023-04-04-upgrade-hyper/</link><pubDate>Tue, 04 Apr 2023 22:15:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-04-04-upgrade-hyper/</guid><description>
&lt;p>Use Azure Arc to automate updates on standalone Hyper-V hosts with intelligent VM management during maintenance windows.&lt;/p>
&lt;h2>Azure Arc Hyper-V Host Management&lt;span class="hx:absolute hx:-mt-20" id="azure-arc-hyper-v-host-management">&lt;/span>
&lt;a href="#azure-arc-hyper-v-host-management" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Azure Arc is a powerful tool for managing and updating hybrid infrastructure, including standalone Hyper-V hosts. This demo shows how to use Azure Arc to update a standalone Hyper-V host, using a scheduled update task in Automation Account and pre and post scripts that shut down and start up VMs.&lt;/p>
&lt;p>Pre-requisites&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Stop all running VMs on the Hyper-V host and wait for them to shut down&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># save the names of the running VMs to a file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$filePath = &lt;span style="color:#e6db74">&amp;#34;C:\temp\runningvm.txt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>(Get-vm | Where-Object { $_.State &lt;span style="color:#f92672">-eq&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Running&amp;#34;&lt;/span> }).name | Out-File $filePath
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$runningvm = Get-Content $filePath
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">foreach&lt;/span> ($Name &lt;span style="color:#66d9ef">in&lt;/span> $runningvm) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Stop-VM $Name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $VM1 = get-vm -Name $Name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Progress -Activity &lt;span style="color:#e6db74">&amp;#34;Waiting for the VM to shutdown&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">until&lt;/span> ($Null &lt;span style="color:#f92672">-eq&lt;/span> $VM1.Heartbeat)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># send a webhook to Teams to notify that the VMs have been shut down&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$webhookUri = &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;@context&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;http://schema.org/extensions&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;@type&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;MessageCard&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;themeColor&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;d70000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;title&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Send Webhook to Teams&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;text&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;This is a message sent from Powershell&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Invoke-RestMethod -Uri $webhookUri -Method Post -Body (ConvertTo-Json -InputObject $body) &lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>Post-requisites&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Start up all VMs that were shut down during the update process&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$filePath = &lt;span style="color:#e6db74">&amp;#34;C:\temp\runningvm.txt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$runningvm = Get-Content $filePath
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">foreach&lt;/span> ($Name &lt;span style="color:#66d9ef">in&lt;/span> $runningvm) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Start-VM $Name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $network = get-vm -name $name | get-VMNetworkAdapter
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Progress -Activity &lt;span style="color:#e6db74">&amp;#34;Waiting for VM Network&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">until&lt;/span> ($network.Status &lt;span style="color:#f92672">-eq&lt;/span> &lt;span style="color:#e6db74">&amp;#34;ok&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Wait for the VM and sleep for 60 seconds for next vm to start ( boot storm if all VMs are started at once)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sleep -seconds &lt;span style="color:#ae81ff">60&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># send a webhook to Teams to notify that the VMs have been started&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$webhookUri = &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;@context&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;http://schema.org/extensions&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;@type&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;MessageCard&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;themeColor&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;d70000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;title&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Send Webhook to Teams&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;text&amp;#34;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;This is a message sent from Powershell&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Invoke-RestMethod -Uri $webhookUri -Method Post -Body (ConvertTo-Json -InputObject $body) &lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>Updating a standalone Hyper-V host can be a complex and time-consuming process, but with Azure Arc and Automation Accounts, you can automate much of the work and ensure a smooth, reliable update process. Hyper-v cluster or HCI is a different story.
{: .prompt-info }&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/before.png" alt="Desktop View" loading="lazy" />&lt;/p></description></item><item><title>Getting licenses assigned to user accounts</title><link>https://lubenz007.github.io/bensiegils/posts/2023-01-04-license-report/</link><pubDate>Sat, 01 Apr 2023 00:27:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-01-04-license-report/</guid><description>
&lt;p>Create a detailed report of licenses assigned to Azure AD user accounts using the Microsoft Graph API. This is a rewrite that uses direct API calls instead of the MgGraph PowerShell module.&lt;/p>
&lt;h2>License Reporting with Microsoft Graph API&lt;span class="hx:absolute hx:-mt-20" id="license-reporting-with-microsoft-graph-api">&lt;/span>
&lt;a href="#license-reporting-with-microsoft-graph-api" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>This is a rewrite from &lt;a href="https://practical365.com/create-licensing-report-microsoft365-tenant/"target="_blank" rel="noopener">practical365.com&lt;/a> - my mission was to rewrite the script to use the Microsoft Graph API instead of the MgGraph PowerShell module.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Info:&lt;/strong> This post shows how to get license reports from Microsoft Graph directly&lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientID = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientSecret = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$tenant_Id = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Connect to Graph #&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Grant_Type = &lt;span style="color:#e6db74">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resource = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_id = $clientId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_secret = $clientSecret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ConnectGraph = Invoke-RestMethod -Uri &lt;span style="color:#e6db74">&amp;#34;https://login.microsoft.com/&lt;/span>$tenant_Id&lt;span style="color:#e6db74">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> -Method POST -Body $Body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Variable Collections #&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$CSVOutputFile = &lt;span style="color:#e6db74">&amp;#34;c:\temp\Microsoft365LicensesReport.CSV&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$today = Get-Date
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Content-Type&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$($ConnectGraph.access_token)&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$token = $ConnectGraph.access_token
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Net.ServicePointManager&lt;/span>]::SecurityProtocol = [&lt;span style="color:#66d9ef">Net.SecurityProtocolType&lt;/span>]::Tls12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> Get-GraphData {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">param&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$AccessToken,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$Uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$AccessToken&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $QueryResults += $Results.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Uri = $Results.&lt;span style="color:#e6db74">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> ($Uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> $QueryResults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#This request get SecureScore&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">array&lt;/span>]$Skus = Get-GraphData -AccessToken $Token -Uri &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com/beta/subscribedSkus&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#[Array]$Skus = Get-MgSubscribedSku&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Generate CSV of all product SKUs used in tenant&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">array&lt;/span>]$Sku = $Skus | Select-Object SkuId, SkuPartNumber
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Generate list of all service plans used in SKUs in tenant&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SPData = [&lt;span style="color:#66d9ef">System.Collections.Generic.List[Object]&lt;/span>]::new()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ForEach&lt;/span> ($Sk &lt;span style="color:#66d9ef">in&lt;/span> $Skus) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">ForEach&lt;/span> ($SP &lt;span style="color:#66d9ef">in&lt;/span> $Sk.ServicePlans) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPLine = [&lt;span style="color:#66d9ef">PSCustomObject][Ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ServicePlanId = $SP.ServicePlanId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ServicePlanName = $SP.ServicePlanName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ServicePlanDisplayName = $SP.ServicePlanName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SPData.Add($SPLine)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$SkuHashTable = @{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ForEach&lt;/span> ($Line &lt;span style="color:#66d9ef">in&lt;/span> $Sku) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SkuHashTable.Add([&lt;span style="color:#66d9ef">string&lt;/span>]$Line.SkuId, [&lt;span style="color:#66d9ef">string&lt;/span>]$Line.skuPartNumber)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ServicePlanHashTable = @{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ForEach&lt;/span> ($Line2 &lt;span style="color:#66d9ef">in&lt;/span> $SPData) { $ServicePlanHashTable.Add([&lt;span style="color:#66d9ef">string&lt;/span>]$Line2.ServicePlanId, [&lt;span style="color:#66d9ef">string&lt;/span>]$Line2.ServicePlanDisplayName) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Array&lt;/span>]$Users = Get-GraphData -AccessToken $Token -Uri &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com/beta/users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Report = [&lt;span style="color:#66d9ef">System.Collections.Generic.List[Object]&lt;/span>]::new()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ForEach&lt;/span> ($User &lt;span style="color:#66d9ef">in&lt;/span> $users) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">If&lt;/span> ([&lt;span style="color:#66d9ef">string&lt;/span>]::IsNullOrWhiteSpace($User.AssignedLicenses) &lt;span style="color:#f92672">-eq&lt;/span> $true) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Only process account if it has some licenses&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Host &lt;span style="color:#e6db74">&amp;#34;Processing&amp;#34;&lt;/span> $User.DisplayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">array&lt;/span>]$LicenseInfo = $Null; [&lt;span style="color:#66d9ef">array&lt;/span>]$DisabledPlans = $Null
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">ForEach&lt;/span> ($License &lt;span style="color:#66d9ef">in&lt;/span> $User.AssignedLicenses) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">If&lt;/span> ($SkuHashTable.ContainsKey($License.SkuId) &lt;span style="color:#f92672">-eq&lt;/span> $True) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># We found a match in the SKU hash table&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $LicenseInfo += $SkuHashTable.Item($License.SkuId)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">Else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Nothing doing, so output the SkuID&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $LicenseInfo += $License
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Report any disabled service plans in licenses&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">If&lt;/span> ([&lt;span style="color:#66d9ef">string&lt;/span>]::IsNullOrWhiteSpace($License.DisabledPlans) &lt;span style="color:#f92672">-eq&lt;/span> $False ) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Check if disabled service plans in a license&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">ForEach&lt;/span> ($DisabledPlan &lt;span style="color:#66d9ef">in&lt;/span> $License.DisabledPlans) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Try and find what service plan is disabled&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">If&lt;/span> ($ServicePlanHashTable.ContainsKey($DisabledPlan) &lt;span style="color:#f92672">-eq&lt;/span> $True) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># We found a match in the Service Plans hash table&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $DisabledPlans += $ServicePlanHashTable.Item($DisabledPlan)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">Else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Nothing doing, so output the Service Plan ID&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $DisabledPlans += $DisabledPlan
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#75715e"># End ForEach disabled plans&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#75715e"># End if check for disabled plans &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#75715e"># End Foreach Licenses&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># Report information&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$DisabledPlans = $DisabledPlans -join &lt;span style="color:#e6db74">&amp;#34;, &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$LicenseInfo = $LicenseInfo -join (&lt;span style="color:#e6db74">&amp;#34;, &amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $ReportLine = [&lt;span style="color:#66d9ef">PSCustomObject][Ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> User = $User.DisplayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UPN = $User.UserPrincipalName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Country = $User.Country
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Department = $User.Department
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Title = $User.JobTitle
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Licenses = $LicenseInfo
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;Disabled Plans&amp;#34;&lt;/span> = $DisabledPlans
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Host $ReportLine
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Report.Add($ReportLine)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#75715e">#end If account is licensed&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">Else&lt;/span> { $UnlicensedAccounts++ }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#75715e"># End ForEach Users&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Report | Export-CSV -NoTypeInformation $CSVOutputFile&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>MS Graph API - Get Secure Score for tenant</title><link>https://lubenz007.github.io/bensiegils/posts/2023-03-23-sgraph-securescore/</link><pubDate>Sat, 25 Mar 2023 22:49:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-03-23-sgraph-securescore/</guid><description>
&lt;p>Get your Microsoft 365 Secure Score using the Microsoft Graph API to monitor your tenant&amp;rsquo;s security posture and track improvements.&lt;/p>
&lt;h2>Secure Score for O365 Tenant&lt;span class="hx:absolute hx:-mt-20" id="secure-score-for-o365-tenant">&lt;/span>
&lt;a href="#secure-score-for-o365-tenant" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Getting the secure score for a tenant is a bit more complicated than getting the last logon time of a user. You only need to call the following endpoint: &lt;a href="https://graph.microsoft.com/beta/security/secureScores"target="_blank" rel="noopener">https://graph.microsoft.com/beta/security/secureScores&lt;/a> and divide the result by 100 to get the percentage.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Needs permission SecurityEvents.Read.All&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientID = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientSecret = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$tenant_Id = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Connect to Graph #&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Grant_Type = &lt;span style="color:#e6db74">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resource = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_id = $clientId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_secret = $clientSecret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ConnectGraph = Invoke-RestMethod -Uri &lt;span style="color:#e6db74">&amp;#34;https://login.microsoft.com/&lt;/span>$tenant_Id&lt;span style="color:#e6db74">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> -Method POST -Body $Body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Variable Collections #&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$path = &lt;span style="color:#e6db74">&amp;#34;C:\temp\&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Content-Type&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;application/json&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$($ConnectGraph.access_token)&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$token = $ConnectGraph.access_token
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Net.ServicePointManager&lt;/span>]::SecurityProtocol = [&lt;span style="color:#66d9ef">Net.SecurityProtocolType&lt;/span>]::Tls12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> Get-GraphData {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">param&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$AccessToken,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$Uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$AccessToken&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $QueryResults += $Results.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Uri = $Results.&lt;span style="color:#e6db74">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> ($Uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> $QueryResults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#This request get SecureScore&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$uri = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com/beta/security/secureScores&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Result = @()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">array&lt;/span>]$Response = Get-GraphData -AccessToken $Token -Uri $uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> ($Response) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">ForEach&lt;/span> ($Respons &lt;span style="color:#66d9ef">in&lt;/span> $Response) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $SecureScore = $Respons.currentScore / $Respons.maxScore * &lt;span style="color:#ae81ff">100&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Result += New-Object PSObject -property $([&lt;span style="color:#66d9ef">ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CreatedDateTime = $Respons.createdDateTime
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CurrentScore = $Respons.currentScore
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MaxScore = $Respons.maxScore
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LicensedUserCount = $Respons.licensedUserCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ActiveUserCount = $Respons.activeUserCount
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SecureScore = [&lt;span style="color:#66d9ef">math&lt;/span>]::Round($SecureScore, &lt;span style="color:#ae81ff">2&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Write-Host &lt;span style="color:#e6db74">&amp;#34;No SecureScore data found&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># export to csv&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Result | export-csv -path &lt;span style="color:#e6db74">&amp;#34;&lt;/span>$path&lt;span style="color:#e6db74">\SecureScore.csv&amp;#34;&lt;/span> -NoTypeInformation&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>Getting Started with MSGraph API</title><link>https://lubenz007.github.io/bensiegils/posts/2023-03-23-sgraph-api/</link><pubDate>Sat, 25 Mar 2023 13:49:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-03-23-sgraph-api/</guid><description>
&lt;p>Microsoft Graph API is a powerful tool for authentication and authorization that allows developers to access Microsoft services and data securely. Learn how to integrate with Outlook, OneDrive, Office 365, Azure Active Directory, and more.&lt;/p>
&lt;h2>Authentication and Authorization&lt;span class="hx:absolute hx:-mt-20" id="authentication-and-authorization">&lt;/span>
&lt;a href="#authentication-and-authorization" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>MSGraph API provides a secure way to authenticate users, authorize applications, and manage user data. With MSGraph API, developers can easily integrate their applications with Microsoft services like Outlook, OneDrive, Office 365, Azure Active Directory, and more.&lt;/p>
&lt;h2>Authentication&lt;span class="hx:absolute hx:-mt-20" id="authentication">&lt;/span>
&lt;a href="#authentication" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>We will use the Azure CLI to create a service principal and get the app id and secret. We will also use the Azure CLI to view all the API permissions available in Microsoft Graph.&lt;span class="hx:absolute hx:-mt-20" id="we-will-use-the-azure-cli-to-create-a-service-principal-and-get-the-app-id-and-secret-we-will-also-use-the-azure-cli-to-view-all-the-api-permissions-available-in-microsoft-graph">&lt;/span>
&lt;a href="#we-will-use-the-azure-cli-to-create-a-service-principal-and-get-the-app-id-and-secret-we-will-also-use-the-azure-cli-to-view-all-the-api-permissions-available-in-microsoft-graph" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;blockquote>
&lt;p>&lt;strong>Info:&lt;/strong> Get the Azure CLI from &lt;a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest"target="_blank" rel="noopener">here&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># login to Azure&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az login
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#View All API Permissions Microsoft Graph to see what is available&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Permissions = az ad sp list --filter &lt;span style="color:#e6db74">&amp;#34;appId eq &amp;#39;00000003-0000-0000-c000-000000000000&amp;#39;&amp;#34;&lt;/span> | ConvertFrom-Json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#to see all permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Permissions.appRoles | Select-Object -Property value,allowedMemberTypes,description
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Get select permission from list above and id to use in next command&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Permissions.appRoles | Select-Object -Property value,allowedMemberTypes,id,description | Where-Object {$_.value &lt;span style="color:#f92672">-eq&lt;/span> &lt;span style="color:#e6db74">&amp;#34;User.Read.All&amp;#34;&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Create service principal&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az ad app create --display-name &lt;span style="color:#e6db74">&amp;#34;Alit-GraphAPI&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Graph API App ID: from output &amp;#34;appId&amp;#34;: &amp;#34;d52bda31-bd71-4a17-b563-7921a17d79e7&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Reset app secret to get new secret&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az ad app credential reset --id &lt;span style="color:#e6db74">&amp;#34;d52bda31-bd71-4a17-b563-7921a17d79e7&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Graph API App Secret: from output&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># &amp;#34;appId&amp;#34;: &amp;#34;d52bda31-bd71-4a17-b563-7921a17d79e7&amp;#34;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># &amp;#34;password&amp;#34;: &amp;#34;3b3b3b3b-3b3b-3b3b-3b3b-3b3b3b3b3b3b&amp;#34;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># &amp;#34;tenant&amp;#34;: &amp;#34;5eeb8561-5493-4b39-906f-038356850aaa&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># set secret to 3 years&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#az ad app credential reset --id 13d15b6f-94ad-4df4-a88d-72f355e5f92d --years 3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Add Microsoft Graph application permission user.read.all # Guide https://learn.microsoft.com/en-us/cli/azure/ad/app/permission?view=azure-cli-latest&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az ad app permission add --id d52bda31-bd71-4a17-b563-7921a17d79e7 --api &lt;span style="color:#ae81ff">00000003&lt;/span>-&lt;span style="color:#ae81ff">0000&lt;/span>-&lt;span style="color:#ae81ff">0000&lt;/span>-c000-&lt;span style="color:#ae81ff">000000000000&lt;/span> --api-permissions df021288-bdef-&lt;span style="color:#ae81ff">4463&lt;/span>-88db-98f22de89214=Role
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Grant admin consent #this needs to be done by a Cloud Application Administrator&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az ad app permission admin-consent --id d52bda31-bd71-4a17-b563-7921a17d79e7
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Get app id &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az ad app list --query &lt;span style="color:#e6db74">&amp;#34;[?displayName==&amp;#39;Alit-GraphAPI&amp;#39;].{id:appId,secret:passwordCredentials[0].value}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># &amp;#34;id&amp;#34;: &amp;#34;d52bda31-bd71-4a17-b563-7921a17d79e7&amp;#34;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># &amp;#34;secret&amp;#34;: null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># }&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#get app api permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az ad app permission list --id d52bda31-bd71-4a17-b563-7921a17d79e7 --output json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># &amp;#34;resourceAccess&amp;#34;: [&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># &amp;#34;id&amp;#34;: &amp;#34;df021288-bdef-4463-88db-98f22de89214&amp;#34;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># &amp;#34;type&amp;#34;: &amp;#34;Role&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># }&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># ],&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># &amp;#34;resourceAppId&amp;#34;: &amp;#34;00000003-0000-0000-c000-000000000000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># }&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>Reference:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.nielskok.tech/azure-ad/view-all-api-permissions-microsoft-graph/"target="_blank" rel="noopener">nielskok.tech&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal"target="_blank" rel="noopener">how-to-create-service-principal-portal&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-authenticate-service-principal-cli"target="_blank" rel="noopener">how-to-authenticate-service-principal-cli&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.c-sharpcorner.com/article/how-to-add-app-roles-in-azure-ad-apps/"target="_blank" rel="noopener">how to-add-app-roles-in-azure-ad-apps&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>MS Graph API - Get User info</title><link>https://lubenz007.github.io/bensiegils/posts/2023-03-23-sgraph-users/</link><pubDate>Sat, 25 Mar 2023 13:49:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/2023-03-23-sgraph-users/</guid><description>
&lt;p>Microsoft Graph API can be used to get comprehensive user information including the last logon time. This guide shows how to query user data including DisplayName, UserPrincipalName, UsageLocation, Country, LastSignInDateTime, IsLicensed, and IsGuestUser.&lt;/p>
&lt;h2>What This Query Retrieves&lt;span class="hx:absolute hx:-mt-20" id="what-this-query-retrieves">&lt;/span>
&lt;a href="#what-this-query-retrieves" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>DisplayName, UserPrincipalName, UsageLocation, Country&lt;/li>
&lt;li>LastSignInDateTime, IsLicensed, IsGuestUser&lt;/li>
&lt;li>Complete user activity and licensing information&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#client_id and client_secret are generated in Azure AD&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientID = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ClientSecret = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$tenant_Id = &lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Create the body of the request.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Body = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Grant_Type = &lt;span style="color:#e6db74">&amp;#34;client_credentials&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resource = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_id = $clientId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client_secret = $clientSecret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Get the access token.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ConnectGraph = Invoke-RestMethod -Uri &lt;span style="color:#e6db74">&amp;#34;https://login.microsoft.com/&lt;/span>$tenant_Id&lt;span style="color:#e6db74">/oauth2/token?api-version=1.0&amp;#34;&lt;/span> -Method POST -Body $Body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Force TLS 1.2.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">Net.ServicePointManager&lt;/span>]::SecurityProtocol = [&lt;span style="color:#66d9ef">Net.SecurityProtocolType&lt;/span>]::Tls12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Get the access token.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$token = $ConnectGraph.access_token
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Variable Collections # &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Result = @()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#This request get users list with signInActivity.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Uri = &lt;span style="color:#e6db74">&amp;#34;https://graph.microsoft.com/beta/users?&lt;/span>$select&lt;span style="color:#e6db74">=displayName,userPrincipalName,contry,UsageLocation,userType,assignedLicenses,signInActivity,lastSignInDateTime&amp;amp;&lt;/span>$top&lt;span style="color:#e6db74">=999&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#function to get graph data with pagination&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> Get-GraphData {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">param&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$AccessToken,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [parameter(&lt;span style="color:#a6e22e">Mandatory&lt;/span>)]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="color:#66d9ef">string&lt;/span>]$Uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Headers = @{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#39;Authorization&amp;#39;&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;Bearer &lt;/span>$AccessToken&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $QueryResults += $Results.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Uri = $Results.&lt;span style="color:#e6db74">&amp;#39;@odata.nextLink&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">while&lt;/span> ($Uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> $QueryResults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Get the users.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#66d9ef">array&lt;/span>]$Users = Get-GraphData -AccessToken $Token -Uri $uri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Loop through the results and add them to the output array.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">ForEach&lt;/span> ($User &lt;span style="color:#66d9ef">in&lt;/span> $Users) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $Result += New-Object PSObject -property $([&lt;span style="color:#66d9ef">ordered&lt;/span>]@{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> DisplayName = $User.displayName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UserPrincipalName = $User.userPrincipalName
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UsageLocation = $user.usageLocation
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Contry = $User.country
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LastSignInDateTime = &lt;span style="color:#66d9ef">if&lt;/span> ($User.signInActivity.lastSignInDateTime) { [&lt;span style="color:#66d9ef">DateTime&lt;/span>]$User.signInActivity.lastSignInDateTime } &lt;span style="color:#66d9ef">Else&lt;/span> { $null }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> IsLicensed = &lt;span style="color:#66d9ef">if&lt;/span> ($User.assignedLicenses.Count &lt;span style="color:#f92672">-ne&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>) { $true } &lt;span style="color:#66d9ef">else&lt;/span> { $false }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> IsGuestUser = &lt;span style="color:#66d9ef">if&lt;/span> ($User.userType &lt;span style="color:#f92672">-eq&lt;/span> &lt;span style="color:#e6db74">&amp;#39;Guest&amp;#39;&lt;/span>) { $true } &lt;span style="color:#66d9ef">else&lt;/span> { $false }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Write the results to a CSV file.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Logfile = &lt;span style="color:#e6db74">&amp;#34;lastlogon.csv&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$LogItem = New-Item -ItemType File -Name $Logfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$Result | ConvertTo-Csv | Out-File $LogItem -Append&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item></channel></rss>