<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>BensiEgils â€“ Azure</title><link>https://lubenz007.github.io/bensiegils/categories/azure/</link><description>Recent content in Azure on BensiEgils</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 18 Aug 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://lubenz007.github.io/bensiegils/categories/azure/index.xml" rel="self" type="application/rss+xml"/><item><title>Migrating from VMware to Azure using Azure Files</title><link>https://lubenz007.github.io/bensiegils/posts/migrating-from-vmware-to-azure-using-azure-files/</link><pubDate>Mon, 18 Aug 2025 00:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/migrating-from-vmware-to-azure-using-azure-files/</guid><description>
&lt;p>When using a tool such as Disk2VHD, you need a storage locationâ€”and sometimes plenty of itâ€”to export the virtual machine (VM).
But what if no local storage is available, and no USB can be connected, such as with a VMware hosting provider?&lt;/p>
&lt;p>In that case, you can export the VHD directly to an Azure File Share and then copy it to Azure Blob Storage.
Note: Dynamically expanding disks are not supported in this processâ€”you must use a fixed-size disk.&lt;/p>
&lt;p>The next step is to provision a Windows Server in Azure, install Hyper-V, and use Hyper-V Manager to convert the disk to a fixed-size VHD.&lt;/p>
&lt;p>After conversion, you can upload the VHD to Azure, create an image from it, and then deploy a VM.
In many cases, Azure will display an error during deployment stating that the VM cannot be customized. You can safely ignore this error.&lt;/p>
&lt;p>Tools You Will Need&lt;/p>
&lt;ul>
&lt;li>Disk2VHD â€“ for exporting the VMware VM to a VHD file.
&lt;ul>
&lt;li>ðŸ”— Download Disk2VHD&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Azure Storage Explorer â€“ for managing Azure File Shares and Blob Storage.
&lt;ul>
&lt;li>ðŸ”— Download Azure Storage Explorer&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Hyper-V Manager â€“ for converting VHDs from dynamic to fixed-size.
&lt;ul>
&lt;li>Installed on VM in Azure&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Step 1:&lt;/strong> Mount Azure File Share&lt;/p>
&lt;p>On the source VMware server and later on the Hyper-V server in Azure, mount the Azure File Share:
Mount as Administrator because disk2vhd runs as Administrator.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/blob.png" alt="Mount Azure File Share" loading="lazy" />&lt;/p>
&lt;p>&lt;strong>Step 2:&lt;/strong> Export VMware VM with Disk2VHD&lt;/p>
&lt;p>Run Disk2VHD on the source server.&lt;/p>
&lt;p>Select the volumes you want to export.&lt;/p>
&lt;p>Choose the Azure File Share as the destination path (after mounting it as a network drive).&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/disk2vhd1.png" alt="Disk2VHD Export" loading="lazy" />
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/uncheck.png" alt="Disk2VHD Uncheck" loading="lazy" />&lt;/p>
&lt;p>&lt;strong>Step 3:&lt;/strong> Convert VHD from Dynamic to Fixed&lt;/p>
&lt;p>Open Hyper-V Manager on the Azure VM.&lt;/p>
&lt;p>Go to Edit Diskâ€¦&lt;/p>
&lt;p>Browse to the VHD file from the Azure File Share.&lt;/p>
&lt;p>Select Convert â†’ Fixed size.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/fxiedsize.png" alt="Fixed Size VHD" loading="lazy" />&lt;/p>
&lt;p>Step 4: Copy VHD to Azure Blob Storage&lt;/p>
&lt;p>Use Azure Storage Explorer ( Use copy and paste in the menu :) )&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/storageexplorer.png" alt="Azure Storage Explorer" loading="lazy" />&lt;/p>
&lt;p>Step 5: Create Azure Managed Image &amp;amp; VM&lt;/p>
&lt;p>In the Azure Portal, go to Images â†’ + Create.&lt;/p>
&lt;p>Select your uploaded VHD as the source.&lt;/p>
&lt;p>Create an image.&lt;/p>
&lt;p>Deploy a VM from that image.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/vmwaremove/azimagecreate.png" alt="Azure Image Create" loading="lazy" />&lt;/p>
&lt;p>Now you can create vm from the image.&lt;/p></description></item><item><title>Arc - Diskspace Monitoring - Teams)</title><link>https://lubenz007.github.io/bensiegils/posts/arc-diskspace-monitoring-teams/</link><pubDate>Sun, 15 Oct 2023 02:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/arc-diskspace-monitoring-teams/</guid><description>
&lt;p>Monitor disk space usage on Azure Arc-enabled servers and receive instant Microsoft Teams notifications when space is running low.&lt;/p>
&lt;h2>Azure Arc Disk Space Monitoring&lt;span class="hx:absolute hx:-mt-20" id="azure-arc-disk-space-monitoring">&lt;/span>
&lt;a href="#azure-arc-disk-space-monitoring" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Upon successfully installing Azure Arc on your Server and activating Insights, you open the door to a powerful monitoring capability. One essential aspect is overseeing disk space usage on your server, ensuring optimal performance and preventing potential issues. This example provides a step-by-step guide on how to set up disk space monitoring and receive instant notifications via Microsoft Teams when space is running low.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Furthermore, this versatile approach can be extended to send email alerts, providing an additional layer of flexibility in how you manage critical resource thresholds. This comprehensive monitoring strategy empowers you with the tools to proactively maintain your server&amp;rsquo;s health and responsiveness, bolstering the reliability of your operations.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The query below is a simple example of how to monitor disk space usage on your server. It returns the percentage of free space on the C: drive, which is then used to trigger an alert when the threshold is exceeded. The query can be customized to monitor other drives on your server, and the threshold can be adjusted to suit your needs.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">InsightsMetrics&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="nb">where &lt;/span>&lt;span class="n">Name&lt;/span> &lt;span class="p">==&lt;/span> &lt;span class="s2">&amp;#34;FreeSpaceMB&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="n">summarize&lt;/span> &lt;span class="n">arg_max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TimeGenerated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">*)&lt;/span> &lt;span class="n">by&lt;/span> &lt;span class="n">Tags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Computer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="n">extend&lt;/span> &lt;span class="n">Drive&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">tostring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parse_json&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Tags&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="s2">&amp;#34;vm.azm.ms/mountId&amp;#34;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="n">extend&lt;/span> &lt;span class="n">Size&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">toreal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parse_json&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Tags&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="s2">&amp;#34;vm.azm.ms/diskSizeMB&amp;#34;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="n">project&lt;/span> &lt;span class="n">TimeGenerated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Computer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Drive&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SizeGB&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Size&lt;/span> &lt;span class="p">/&lt;/span> &lt;span class="mf">1024&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">bin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FreeGB&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Val&lt;/span> &lt;span class="p">/&lt;/span> &lt;span class="mf">1024&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="n">join&lt;/span> &lt;span class="n">kind&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">inner&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">InsightsMetrics&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> &lt;span class="nb">where &lt;/span>&lt;span class="n">Name&lt;/span> &lt;span class="p">==&lt;/span> &lt;span class="s2">&amp;#34;FreeSpacePercentage&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> &lt;span class="n">summarize&lt;/span> &lt;span class="n">arg_max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TimeGenerated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">*)&lt;/span> &lt;span class="n">by&lt;/span> &lt;span class="n">Tags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Computer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> &lt;span class="n">extend&lt;/span> &lt;span class="n">Drive&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">tostring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parse_json&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Tags&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="s2">&amp;#34;vm.azm.ms/mountId&amp;#34;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> &lt;span class="n">project&lt;/span> &lt;span class="n">TimeGenerated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Computer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Drive&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FreePercent&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">1.1&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="n">on&lt;/span> &lt;span class="n">Computer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Drive&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="n">project&lt;/span> &lt;span class="n">TimeGenerated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Computer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Drive&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SizeGB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FreeGB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FreePercent&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="nb">where &lt;/span>&lt;span class="n">FreePercent&lt;/span> &lt;span class="p">&amp;lt;=&lt;/span> &lt;span class="mf">90.0&lt;/span> &lt;span class="p">//&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">//|&lt;/span> &lt;span class="nb">where &lt;/span>&lt;span class="n">FreeGB&lt;/span> &lt;span class="p">&amp;lt;=&lt;/span> &lt;span class="mf">10.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="n">order&lt;/span> &lt;span class="n">by&lt;/span> &lt;span class="n">Computer&lt;/span> &lt;span class="n">asc&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>
&lt;p>We need to enable webhooks in Microsoft Teams and copy the webhook URL. Finally, we need to create Azure automation runbook and configure it to send notifications to the channel.
We also need to enable the Azure Automation account to access the Log Analytics workspace. To do this, we need to give automation account read access to the Log Analytics workspace and resource group where the arc servers are located.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>the runbook code is the following:&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl"> &lt;span class="c"># So we are going to use the same query as in Azure Monitor to get the results and send it to Teams&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c"># Connect to Azure for Log Analytics&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Connect-AzAccount&lt;/span> &lt;span class="n">-Identity&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$context&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Set-AzContext&lt;/span> &lt;span class="n">-Subscription&lt;/span> &lt;span class="s2">&amp;#34;Your Subscription Name&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$workspaceName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;arc-servers&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$workspaceRG&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;arc-servers&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$WorkspaceID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-AzOperationalInsightsWorkspace&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="nv">$workspaceName&lt;/span> &lt;span class="n">-ResourceGroupName&lt;/span> &lt;span class="nv">$workspaceRG&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">CustomerID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$query&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;InsightsMetrics
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| where Name == &lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">FreeSpaceMB&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| summarize arg_max(TimeGenerated, *) by Tags, Computer
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| extend Drive = tostring(parse_json(Tags)[&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">vm.azm.ms/mountId&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">])
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| extend Size = toreal(parse_json(Tags)[&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">vm.azm.ms/diskSizeMB&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">])
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| project TimeGenerated, Computer, Drive, bin(SizeGB = Size / 1024, 0.1), bin(FreeGB = Val / 1024, 1)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| join kind=inner (InsightsMetrics
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> | where Name == &lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">FreeSpacePercentage&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> | summarize arg_max(TimeGenerated, *) by Tags, Computer
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> | extend Drive = tostring(parse_json(Tags)[&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">vm.azm.ms/mountId&lt;/span>&lt;span class="se">`&amp;#34;&lt;/span>&lt;span class="s2">])
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> | project TimeGenerated, Computer, Drive, bin(FreePercent = Val, 1.1))on Computer, Drive
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| project TimeGenerated, Computer, Drive, SizeGB, FreeGB, FreePercent
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| where FreePercent &amp;lt;= 90.0 //
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">//| where FreeGB &amp;lt;= 10.0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">| order by Computer asc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$kqlQuery&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Invoke-AzOperationalInsightsQuery&lt;/span> &lt;span class="n">-WorkspaceId&lt;/span> &lt;span class="nv">$WorkspaceID&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="nv">$query&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$webhookUri&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;your webhook url&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c"># Define the message as a PowerShell object&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$message&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">context&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;http://schema.org/extensions&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">type &lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;MessageCard&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">themeColor&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;d70000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">title&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Machine with low disk space&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">text&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">$(&lt;/span>&lt;span class="nv">$kqlQuery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">results&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-String&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Convert the message to JSON&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$jsonMessage&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$message&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ConvertTo-Json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Send the message using Invoke-RestMethod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-RestMethod&lt;/span> &lt;span class="n">-Method&lt;/span> &lt;span class="n">Post&lt;/span> &lt;span class="n">-ContentType&lt;/span> &lt;span class="s1">&amp;#39;application/json&amp;#39;&lt;/span> &lt;span class="n">-Body&lt;/span> &lt;span class="nv">$jsonMessage&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="nv">$webhookUri&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>
&lt;p>Select create alert rule
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/AzureMonitor.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Create a new alert rule
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Create_an_alert_rule.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Create action group
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Action_Group.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Select the runbook with teams notification that we create before&lt;/p>
&lt;/li>
&lt;li>
&lt;p>the result in teams
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/diskalert_teams.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Azure Arc - (Azure Cli - ssh - rdp)</title><link>https://lubenz007.github.io/bensiegils/posts/azure-arc-azure-cli-ssh-rdp/</link><pubDate>Sun, 08 Oct 2023 02:00:00 +0000</pubDate><guid>https://lubenz007.github.io/bensiegils/posts/azure-arc-azure-cli-ssh-rdp/</guid><description>
&lt;p>If you have deployed Azure Arc, you have the option to utilize Windows Admin Center for Windows Machines. Additionally, you can enable the OpenSSH Extension on Windows Server, granting the capability to establish SSH tunnels to the localhost or other machines that support RDP/SSH connections.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/SSH-Tunnel.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>To begin the process, please follow these steps:&lt;/p>
&lt;p>Ensure that you have the Azure CLI installed on your local computer. If it is not already installed, open PowerShell and execute the command: winget install -e &amp;ndash;id Microsoft.AzureCLI.&lt;/p>
&lt;p>If you are using a different operating system, refer to the official guide on how to install the Azure CLI provided by Microsoft Learn:
&lt;a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli"target="_blank" rel="noopener">How to install the Azure CLI | Microsoft Learn.&lt;/a>&lt;/p>
&lt;p>Next, enable the OpenSSH extension on the VM where Azure Arc is deployed.&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Enable-SSH.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Settings-Extensions.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;ul>
&lt;li>Logon to Azure With Azure CLi&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">PS &lt;/span>&lt;span class="n">C:&lt;/span>&lt;span class="p">\&amp;gt;&lt;/span> &lt;span class="n">az&lt;/span> &lt;span class="n">login&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>&lt;strong>Tip:&lt;/strong> Please use Multi-Factor Authentication for added security.&lt;/p>
&lt;/blockquote>
&lt;p>The we go to the Connect settings and select password authentication on the VM
&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/Connect_string.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>Copy the connect string and paste to Powershell and add &amp;ldquo;-L 3333:192.168.x.x:3389&amp;rdquo; the ip of the host you want to connect to.&lt;/p>
&lt;div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code">
&lt;div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">az&lt;/span> &lt;span class="n">ssh&lt;/span> &lt;span class="n">arc&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-subscription&lt;/span> &lt;span class="s2">&amp;#34;asdfasdfadf-adfadsfadsf-sdfc&amp;#34;&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-resource-group&lt;/span> &lt;span class="s2">&amp;#34;Arc-Servers&amp;#34;&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-name&lt;/span> &lt;span class="s2">&amp;#34;HYPER-01&amp;#34;&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-local-user&lt;/span> &lt;span class="s2">&amp;#34;administrator&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;-L 3333:192.168.81.25:3389&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0">
&lt;button
class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50"
title="Copy code"
>
&lt;div class="hextra-copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;div class="hextra-success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/RDP_Session1.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>&lt;img src="https://lubenz007.github.io/bensiegils/assets/img/blog/RDP_Session2.png" alt="Desktop View" loading="lazy" />&lt;/p>
&lt;p>And you are connect over SSH tunnel with RDP.&lt;/p></description></item></channel></rss>